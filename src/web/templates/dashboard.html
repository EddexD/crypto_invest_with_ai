<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½åŠ å¯†è´§å¸æŠ•èµ„åŠ©æ‰‹</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .smart-analysis-section {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .chart-section {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .portfolio-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .orders-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .card-title {
            font-size: 1.3em;
            margin-bottom: 15px;
            color: #333;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 10px;
        }

        .metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .metric:last-child {
            border-bottom: none;
        }

        .metric-label {
            color: #666;
        }

        .metric-value {
            font-weight: bold;
            font-size: 1.1em;
        }

        .positive {
            color: #4CAF50;
        }

        .negative {
            color: #f44336;
        }

        .recommendation {
            border-left: 4px solid #2196F3;
            padding: 15px;
            margin: 10px 0;
            background: #f8f9ff;
            border-radius: 5px;
        }

        .recommendation.buy {
            border-left-color: #4CAF50;
            background: #f8fff8;
        }

        .recommendation.sell {
            border-left-color: #f44336;
            background: #fff8f8;
        }

        .recommendation.hold {
            border-left-color: #ff9800;
            background: #fffdf8;
        }

        .recommendation-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .recommendation-symbol {
            font-weight: bold;
            font-size: 1.2em;
        }

        .recommendation-action {
            padding: 5px 15px;
            border-radius: 20px;
            color: white;
            font-weight: bold;
            text-transform: uppercase;
        }

        .action-buy {
            background: #4CAF50;
        }

        .action-sell {
            background: #f44336;
        }

        .action-hold {
            background: #ff9800;
        }

        .confidence-bar {
            width: 100%;
            height: 10px;
            background: #e0e0e0;
            border-radius: 5px;
            overflow: hidden;
            margin: 10px 0;
        }

        .confidence-fill {
            height: 100%;
            background: linear-gradient(90deg, #f44336, #ff9800, #4CAF50);
            transition: width 0.3s ease;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .table th,
        .table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        .table th {
            background: #f5f5f5;
            font-weight: bold;
            color: #333;
        }

        .table tr:hover {
            background: #f9f9f9;
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 20px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .error {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            border-left: 4px solid #c62828;
        }

        .refresh-btn {
            background: #2196F3;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            transition: background 0.3s ease;
        }

        .refresh-btn:hover {
            background: #1976D2;
        }

        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-online {
            background: #4CAF50;
        }

        .status-offline {
            background: #f44336;
        }

        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .smart-analysis-section {
                grid-template-columns: 1fr;
            }
            
            .chart-section {
                grid-template-columns: 1fr;
            }
            
            .portfolio-section {
                grid-template-columns: 1fr;
            }
            
            .orders-section {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .container {
                padding: 10px;
            }
        }

        /* å¼‚æ­¥åˆ†ææ ·å¼ */
        .analysis-loading {
            text-align: center;
            padding: 40px 20px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 15px;
            border: 2px dashed #6c757d;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
            margin: 20px 0;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #28a745, #20c997, #17a2b8);
            border-radius: 10px;
            transition: width 0.5s ease;
            position: relative;
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent 33%, rgba(255,255,255,0.3) 33%, rgba(255,255,255,0.3) 66%, transparent 66%);
            background-size: 30px 30px;
            animation: progressStripe 1s linear infinite;
        }

        @keyframes progressStripe {
            0% { background-position: 0 0; }
            100% { background-position: 30px 0; }
        }

        .progress-text {
            font-size: 0.9em;
            color: #6c757d;
            margin-top: 10px;
        }

        .cancel-btn, .retry-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 15px;
            font-size: 0.9em;
            transition: background 0.3s ease;
        }

        .retry-btn {
            background: #28a745;
        }

        .cancel-btn:hover {
            background: #c82333;
        }

        .retry-btn:hover {
            background: #1e7e34;
        }

        .error {
            text-align: center;
            padding: 30px;
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 10px;
            color: #721c24;
        }

        .cancelled {
            text-align: center;
            padding: 30px;
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 10px;
            color: #856404;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #6c757d;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¤– æ™ºèƒ½åŠ å¯†è´§å¸æŠ•èµ„åŠ©æ‰‹</h1>
            <p>æ™ºèƒ½åˆ†æ Â· ç²¾å‡†å»ºè®® Â· ç¨³å¥æŠ•èµ„</p>
            <div style="margin-top: 15px;">
                <span class="status-indicator" id="statusIndicator"></span>
                <span id="statusText">è¿æ¥ä¸­...</span>
                <button class="refresh-btn" onclick="refreshAllData()" style="margin-left: 20px;">åˆ·æ–°æ•°æ®</button>
                <button class="refresh-btn" onclick="saveSnapshot()" style="margin-left: 10px;">ä¿å­˜å¿«ç…§</button>
            </div>
        </div>

        <!-- ç¬¬ä¸€è¡Œï¼šæŠ•èµ„ç»„åˆè¡¨ç°å›¾è¡¨ -->
        <div class="chart-section">
            <div class="card">
                <div class="card-title">ğŸ“ˆ æŠ•èµ„ç»„åˆè¡¨ç°</div>
                <div class="chart-container">
                    <canvas id="portfolioChart"></canvas>
                </div>
            </div>
        </div>

        <!-- ç¬¬ä¸‰è¡Œï¼šæŠ•èµ„ç»„åˆæ¦‚è§ˆã€å¸‚åœºæ•°æ®ã€æŒä»“è¯¦æƒ… -->
        <div class="portfolio-section">
            <!-- æŠ•èµ„ç»„åˆæ¦‚è§ˆ -->
            <div class="card">
                <div class="card-title">ğŸ“Š æŠ•èµ„ç»„åˆæ¦‚è§ˆ</div>
                <div id="portfolioOverview">
                    <div class="loading">åŠ è½½ä¸­...</div>
                </div>
            </div>

            <!-- å¸‚åœºæ•°æ® -->
            <div class="card">
                <div class="card-title">ğŸ“ˆ å¸‚åœºæ•°æ®</div>
                <div id="marketData">
                    <div class="loading">åŠ è½½ä¸­...</div>
                </div>
            </div>

            <!-- æŒä»“è¯¦æƒ… -->
            <div class="card">
                <div class="card-title">ğŸ’° æŒä»“è¯¦æƒ…</div>
                <div id="positions">
                    <div class="loading">åŠ è½½ä¸­...</div>
                </div>
            </div>
        </div>

        <!-- ç¬¬ä¸‰è¡Œï¼šè®¢å•ä¿¡æ¯ -->
        <div class="orders-section">
            <div class="card">
                <div class="card-title">ğŸ“‹ æœªå®Œæˆè®¢å•</div>
                <div id="openOrders">
                    <div class="loading">åŠ è½½ä¸­...</div>
                </div>
            </div>

            <div class="card">
                <div class="card-title">ğŸ”„ æœ€è¿‘äº¤æ˜“</div>
                <div id="recentTrades">
                    <div class="loading">åŠ è½½ä¸­...</div>
                </div>
            </div>
        </div>

        <!-- ç¬¬å››è¡Œï¼šæ™ºèƒ½æŠ•èµ„åˆ†æï¼ˆç§»åˆ°æœ€ä¸‹æ–¹ï¼‰ -->
        <div class="smart-analysis-section">
            <div class="card">
                <div class="card-title">
                    ğŸ§  OpenAIæ™ºèƒ½æŠ•èµ„åˆ†æ
                    <div style="float: right; font-size: 0.8em;">
                        <button onclick="loadSmartAnalysis(true)" class="refresh-btn" title="å¼ºåˆ¶åˆ·æ–°åˆ†æ">
                            ğŸ”„ é‡æ–°åˆ†æ
                        </button>
                    </div>
                </div>
                <div id="smartAnalysis">
                    <div class="loading">ç­‰å¾…åˆ†æ...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let portfolioChart = null;
        let currentAnalysisTaskId = null; // å½“å‰åˆ†æä»»åŠ¡ID

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            refreshAllData();
            // ç¬¬ä¸€æ¬¡åŠ è½½æ—¶å¯åŠ¨æ™ºèƒ½åˆ†æ
            loadSmartAnalysis();
            // æ¯åˆ†é’Ÿè‡ªåŠ¨åˆ·æ–°ä¸€æ¬¡ï¼ˆä¸åŒ…æ‹¬æ™ºèƒ½åˆ†æï¼‰
            setInterval(refreshAllData, 60000);
        });

        // ä¿å­˜æŠ•èµ„ç»„åˆå¿«ç…§
        async function saveSnapshot() {
            try {
                const response = await fetch('/api/portfolio/save_snapshot', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    alert('âœ… å¿«ç…§ä¿å­˜æˆåŠŸï¼');
                    // é‡æ–°åŠ è½½æŠ•èµ„ç»„åˆæ•°æ®
                    loadPortfolioData();
                } else {
                    alert('âŒ ä¿å­˜å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                alert('âŒ ä¿å­˜å¤±è´¥: ' + error.message);
            }
        }

        // åˆ·æ–°æ‰€æœ‰æ•°æ®
        async function refreshAllData() {
            updateStatus('connecting');
            
            try {
                const loadTasks = [
                    loadPortfolioData(),
                    loadMarketData(),
                    loadOrders(),
                    loadTrades()
                ];
                
                // ä¸å†è‡ªåŠ¨åŠ è½½æ™ºèƒ½åˆ†æï¼Œåªæœ‰ç”¨æˆ·ä¸»åŠ¨ç‚¹å‡»æ‰åŠ è½½
                // loadTasks.push(loadSmartAnalysis());
                
                await Promise.all(loadTasks);
                updateStatus('online');
            } catch (error) {
                console.error('åˆ·æ–°æ•°æ®å¤±è´¥:', error);
                updateStatus('offline');
            }
        }

        // æ›´æ–°è¿æ¥çŠ¶æ€
        function updateStatus(status) {
            const indicator = document.getElementById('statusIndicator');
            const text = document.getElementById('statusText');
            
            if (status === 'online') {
                indicator.className = 'status-indicator status-online';
                text.textContent = 'å·²è¿æ¥';
            } else if (status === 'offline') {
                indicator.className = 'status-indicator status-offline';
                text.textContent = 'è¿æ¥å¤±è´¥';
            } else {
                indicator.className = 'status-indicator';
                text.textContent = 'è¿æ¥ä¸­...';
            }
        }

        // åŠ è½½æŠ•èµ„ç»„åˆæ•°æ®
        async function loadPortfolioData() {
            try {
                const response = await fetch('/api/portfolio');
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                updatePortfolioOverview(data);
                updatePositions(data.positions);
                
                // åŠ è½½å†å²æ•°æ®ç”¨äºå›¾è¡¨
                const historyResponse = await fetch('/api/portfolio/history');
                const historyData = await historyResponse.json();
                
                if (!historyData.error) {
                    updatePortfolioChart(historyData);
                }
                
            } catch (error) {
                document.getElementById('portfolioOverview').innerHTML = 
                    `<div class="error">åŠ è½½å¤±è´¥: ${error.message}</div>`;
            }
        }

        // æ›´æ–°æŠ•èµ„ç»„åˆæ¦‚è§ˆ
        function updatePortfolioOverview(data) {
            const container = document.getElementById('portfolioOverview');
            
            container.innerHTML = `
                <div class="metric">
                    <span class="metric-label">æ€»ä»·å€¼</span>
                    <span class="metric-value">$${data.total_value?.toFixed(2) || '0.00'}</span>
                </div>
                <div class="metric">
                    <span class="metric-label">æ€»æˆæœ¬</span>
                    <span class="metric-value">$${data.total_cost?.toFixed(2) || '0.00'}</span>
                </div>
                <div class="metric">
                    <span class="metric-label">æœªå®ç°ç›ˆäº</span>
                    <span class="metric-value ${data.total_pnl >= 0 ? 'positive' : 'negative'}">
                        $${data.total_pnl?.toFixed(2) || '0.00'} (${(data.total_pnl_rate * 100)?.toFixed(2) || '0.00'}%)
                    </span>
                </div>
                <div class="metric">
                    <span class="metric-label">æ€»æ”¶ç›Šç‡</span>
                    <span class="metric-value ${data.performance?.total_return >= 0 ? 'positive' : 'negative'}">
                        ${(data.performance?.total_return * 100)?.toFixed(2) || '0.00'}%
                    </span>
                </div>
            `;
        }

        // æ›´æ–°æŒä»“ä¿¡æ¯
        function updatePositions(positions) {
            const container = document.getElementById('positions');
            
            if (!positions || positions.length === 0) {
                container.innerHTML = '<div class="loading">æš‚æ— æŒä»“</div>';
                return;
            }
            
            let html = '<table class="table"><tr><th>å¸ç§</th><th>æ•°é‡</th><th>å¸‚å€¼</th><th>ç›ˆäº</th></tr>';
            
            positions.forEach(pos => {
                html += `
                    <tr>
                        <td>${pos.currency}</td>
                        <td>${pos.amount?.toFixed(4) || '0'}</td>
                        <td>$${pos.market_value?.toFixed(2) || '0.00'}</td>
                        <td class="${pos.unrealized_pnl >= 0 ? 'positive' : 'negative'}">
                            $${pos.unrealized_pnl?.toFixed(2) || '0.00'}
                        </td>
                    </tr>
                `;
            });
            
            html += '</table>';
            container.innerHTML = html;
        }

        // åŠ è½½å¸‚åœºæ•°æ®
        async function loadMarketData() {
            try {
                const response = await fetch('/api/market_data');
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                updateMarketData(data.market_data);
                
            } catch (error) {
                document.getElementById('marketData').innerHTML = 
                    `<div class="error">åŠ è½½å¤±è´¥: ${error.message}</div>`;
            }
        }

        // æ›´æ–°å¸‚åœºæ•°æ®
        function updateMarketData(marketData) {
            const container = document.getElementById('marketData');
            
            if (!marketData || Object.keys(marketData).length === 0) {
                container.innerHTML = '<div class="loading">æš‚æ— æ•°æ®</div>';
                return;
            }
            
            let html = '<table class="table"><tr><th>äº¤æ˜“å¯¹</th><th>ä»·æ ¼</th><th>24hå˜åŒ–</th></tr>';
            
            Object.entries(marketData).forEach(([symbol, data]) => {
                html += `
                    <tr>
                        <td>${symbol}</td>
                        <td>$${data.price?.toFixed(2) || '0.00'}</td>
                        <td class="${data.percentage >= 0 ? 'positive' : 'negative'}">
                            ${data.percentage?.toFixed(2) || '0.00'}%
                        </td>
                    </tr>
                `;
            });
            
            html += '</table>';
            container.innerHTML = html;
        }

        // åŠ è½½æ™ºèƒ½åˆ†æï¼ˆå¼‚æ­¥ç‰ˆæœ¬ï¼‰
        async function loadSmartAnalysis(forceRefresh = false) {
            try {
                // å¦‚æœå·²æœ‰æ­£åœ¨è¿›è¡Œçš„ä»»åŠ¡ï¼Œå…ˆæ¸…ç†
                if (currentAnalysisTaskId) {
                    currentAnalysisTaskId = null;
                }
                
                // é¦–å…ˆæ˜¾ç¤ºåŸºç¡€åˆ†æï¼Œè®©ç”¨æˆ·ç«‹å³çœ‹åˆ°ç»“æœ
                try {
                    const basicResponse = await fetch('/api/portfolio/basic-analysis');
                    const basicResult = await basicResponse.json();
                    
                    if (basicResponse.ok && basicResult.analysis) {
                        updateBasicAnalysis(basicResult.analysis);
                    }
                } catch (error) {
                    console.warn('è·å–åŸºç¡€åˆ†æå¤±è´¥:', error);
                }
                
                // ç„¶åå¯åŠ¨OpenAI AIåˆ†æ
                const container = document.getElementById('smartAnalysis');
                
                // åœ¨åŸºç¡€åˆ†æä¸Šæ–¹æ·»åŠ AIåˆ†æè¿›åº¦
                const aiAnalysisDiv = document.createElement('div');
                aiAnalysisDiv.id = 'aiAnalysisProgress';
                aiAnalysisDiv.innerHTML = `
                    <div class="analysis-loading" style="margin-bottom: 20px;">
                        <div class="loading-spinner"></div>
                        <h3>ğŸ¤– OpenAI AIåˆ†æè¿›è¡Œä¸­...</h3>
                        <p>æ­£åœ¨ä¸ºæ‚¨æä¾›æ›´æ·±å…¥çš„æ™ºèƒ½åˆ†æ...</p>
                        <div class="progress-bar">
                            <div class="progress-fill" id="analysisProgress" style="width: 10%;"></div>
                        </div>
                        <div class="progress-text" id="progressText">å‡†å¤‡ä¸­...</div>
                        <button class="cancel-btn" onclick="cancelAnalysis()">å–æ¶ˆAIåˆ†æ</button>
                    </div>
                `;
                
                // å¦‚æœå·²æœ‰åŸºç¡€åˆ†æï¼Œå°†AIè¿›åº¦æ’å…¥åˆ°é¡¶éƒ¨
                if (container.firstChild && !container.firstChild.id?.includes('aiAnalysis')) {
                    container.insertBefore(aiAnalysisDiv, container.firstChild);
                } else {
                    container.appendChild(aiAnalysisDiv);
                }
                
                // å¯åŠ¨AIåˆ†æä»»åŠ¡
                const startResponse = await fetch(`/api/smart-analysis${forceRefresh ? '?force_refresh=true' : ''}`);
                const startResult = await startResponse.json();
                
                if (!startResponse.ok) {
                    // AIåˆ†æå¯åŠ¨å¤±è´¥ï¼Œç§»é™¤è¿›åº¦æ˜¾ç¤º
                    const progressDiv = document.getElementById('aiAnalysisProgress');
                    if (progressDiv) {
                        progressDiv.remove();
                    }
                    
                    // åœ¨åŸºç¡€åˆ†æä¸‹æ–¹æ˜¾ç¤ºAIåˆ†æå¤±è´¥æç¤º
                    const errorDiv = document.createElement('div');
                    errorDiv.innerHTML = `
                        <div class="error" style="margin-top: 20px;">
                            <h3>ğŸ¤– AIåˆ†æå¯åŠ¨å¤±è´¥</h3>
                            <p>${startResult.error || 'å¯åŠ¨åˆ†æå¤±è´¥'}</p>
                            <button onclick="loadSmartAnalysis(true)" class="retry-btn">é‡è¯•AIåˆ†æ</button>
                        </div>
                    `;
                    container.appendChild(errorDiv);
                    return;
                }
                
                currentAnalysisTaskId = startResult.task_id;
                
                // å¼€å§‹æ™ºèƒ½è½®è¯¢çŠ¶æ€
                startSmartPolling(currentAnalysisTaskId);
                
            } catch (error) {
                // å®Œå…¨å¤±è´¥æ—¶ï¼Œå°è¯•æ˜¾ç¤ºåŸºç¡€åˆ†æ
                try {
                    const basicResponse = await fetch('/api/portfolio/basic-analysis');
                    const basicResult = await basicResponse.json();
                    
                    if (basicResponse.ok && basicResult.analysis) {
                        updateBasicAnalysis(basicResult.analysis);
                        
                        // åœ¨åŸºç¡€åˆ†æä¸‹æ–¹æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
                        const container = document.getElementById('smartAnalysis');
                        const errorDiv = document.createElement('div');
                        errorDiv.innerHTML = `
                            <div class="error" style="margin-top: 20px;">
                                <h3>ğŸ¤– AIåˆ†æä¸å¯ç”¨</h3>
                                <p>${error.message}</p>
                                <button onclick="loadSmartAnalysis(true)" class="retry-btn">é‡è¯•AIåˆ†æ</button>
                            </div>
                        `;
                        container.appendChild(errorDiv);
                    } else {
                        throw error;
                    }
                } catch (fallbackError) {
                    document.getElementById('smartAnalysis').innerHTML = 
                        `<div class="error">
                            <h3>âŒ åˆ†æåŠŸèƒ½ä¸å¯ç”¨</h3>
                            <p>æ— æ³•è·å–æŠ•èµ„ç»„åˆåˆ†æ: ${error.message}</p>
                            <button onclick="loadSmartAnalysis(true)" class="retry-btn">é‡è¯•</button>
                        </div>`;
                }
            }
        }

        // æ™ºèƒ½è½®è¯¢ - æ ¹æ®ä»»åŠ¡çŠ¶æ€è°ƒæ•´è½®è¯¢é¢‘ç‡
        function startSmartPolling(taskId) {
            let pollCount = 0;
            const maxPolls = 150; // æœ€å¤šè½®è¯¢150æ¬¡ï¼ˆå¤§çº¦10åˆ†é’Ÿï¼‰
            
            function poll() {
                pollCount++;
                
                // å‰30ç§’æ¯2ç§’æ£€æŸ¥ä¸€æ¬¡ï¼Œä¹‹åæ¯5ç§’æ£€æŸ¥ä¸€æ¬¡
                const interval = pollCount < 15 ? 2000 : 5000;
                
                checkAnalysisStatus(taskId).then((isCompleted) => {
                    // å¦‚æœä»»åŠ¡å®Œæˆæˆ–è€…å½“å‰ä»»åŠ¡IDå·²å˜åŒ–ï¼Œåœæ­¢è½®è¯¢
                    if (isCompleted || currentAnalysisTaskId !== taskId) {
                        return;
                    }
                    
                    // å¦‚æœä»»åŠ¡è¿˜åœ¨è¿›è¡Œä¸”æœªè¶…è¿‡æœ€å¤§è½®è¯¢æ¬¡æ•°
                    if (pollCount < maxPolls) {
                        setTimeout(poll, interval);
                    } else {
                        // è¶…è¿‡æœ€å¤§è½®è¯¢æ¬¡æ•°
                        currentAnalysisTaskId = null;
                        document.getElementById('smartAnalysis').innerHTML = 
                            `<div class="error">
                                <h3>â° è½®è¯¢è¶…æ—¶</h3>
                                <p>åˆ†æä»»åŠ¡å¯èƒ½éœ€è¦æ›´é•¿æ—¶é—´ï¼Œè¯·ç¨åæ‰‹åŠ¨åˆ·æ–°</p>
                                <button onclick="loadSmartAnalysis(true)" class="retry-btn">é‡æ–°åˆ†æ</button>
                            </div>`;
                    }
                }).catch(error => {
                    console.error('è½®è¯¢é”™è¯¯:', error);
                    currentAnalysisTaskId = null;
                });
            }
            
            // ç«‹å³å¼€å§‹ç¬¬ä¸€æ¬¡æ£€æŸ¥
            poll();
        }

        // æ£€æŸ¥åˆ†æçŠ¶æ€
        async function checkAnalysisStatus(taskId) {
            try {
                const response = await fetch(`/api/analysis-status/${taskId}`);
                const statusData = await response.json();
                
                if (!response.ok) {
                    throw new Error(statusData.error || 'è·å–çŠ¶æ€å¤±è´¥');
                }
                
                const progress = Math.round(statusData.progress * 100);
                const progressBar = document.getElementById('analysisProgress');
                const progressText = document.getElementById('progressText');
                
                if (progressBar) {
                    progressBar.style.width = `${progress}%`;
                }
                
                // æ›´æ–°çŠ¶æ€æ–‡æœ¬
                let statusText = '';
                switch (statusData.status) {
                    case 'pending':
                        statusText = 'ç­‰å¾…å¤„ç†...';
                        break;
                    case 'running':
                        if (progress < 30) {
                            statusText = 'è·å–å¸‚åœºæ•°æ®...';
                        } else if (progress < 60) {
                            statusText = 'OpenAI AI åˆ†æä¸­...';
                        } else if (progress < 90) {
                            statusText = 'ç”ŸæˆæŠ•èµ„å»ºè®®...';
                        } else {
                            statusText = 'å®Œæˆåˆ†æ...';
                        }
                        break;
                    case 'completed':
                        statusText = 'åˆ†æå®Œæˆï¼';
                        currentAnalysisTaskId = null; // æ¸…é™¤å½“å‰ä»»åŠ¡ID
                        
                        // ç§»é™¤AIåˆ†æè¿›åº¦æ˜¾ç¤º
                        const progressDiv = document.getElementById('aiAnalysisProgress');
                        if (progressDiv) {
                            progressDiv.remove();
                        }
                        
                        // ç”¨AIåˆ†æç»“æœæ›¿æ¢æˆ–æ›´æ–°ç°æœ‰å†…å®¹
                        updateSmartAnalysis(statusData.result);
                        return true; // è¿”å›trueè¡¨ç¤ºä»»åŠ¡å®Œæˆ
                    case 'failed':
                        statusText = `åˆ†æå¤±è´¥: ${statusData.error}`;
                        currentAnalysisTaskId = null; // æ¸…é™¤å½“å‰ä»»åŠ¡ID
                        document.getElementById('smartAnalysis').innerHTML = 
                            `<div class="error">
                                <h3>âŒ åˆ†æå¤±è´¥</h3>
                                <p>${statusData.error}</p>
                                <button onclick="loadSmartAnalysis(true)" class="retry-btn">é‡æ–°åˆ†æ</button>
                            </div>`;
                        return true; // è¿”å›trueè¡¨ç¤ºä»»åŠ¡å®Œæˆ
                    case 'timeout':
                        statusText = 'åˆ†æè¶…æ—¶';
                        currentAnalysisTaskId = null; // æ¸…é™¤å½“å‰ä»»åŠ¡ID
                        document.getElementById('smartAnalysis').innerHTML = 
                            `<div class="error">
                                <h3>â° åˆ†æè¶…æ—¶</h3>
                                <p>OpenAI APIå“åº”è¶…æ—¶ï¼Œè¯·ç¨åé‡è¯•</p>
                                <button onclick="loadSmartAnalysis(true)" class="retry-btn">é‡æ–°åˆ†æ</button>
                            </div>`;
                        return true; // è¿”å›trueè¡¨ç¤ºä»»åŠ¡å®Œæˆ
                }
                
                if (progressText) {
                    progressText.textContent = `${statusText} (${progress}%)`;
                }
                
                return false; // è¿”å›falseè¡¨ç¤ºä»»åŠ¡æœªå®Œæˆï¼Œç»§ç»­è½®è¯¢
                
            } catch (error) {
                console.error('æ£€æŸ¥åˆ†æçŠ¶æ€å¤±è´¥:', error);
                return true; // å‡ºé”™æ—¶åœæ­¢è½®è¯¢
            }
        }

        // å–æ¶ˆåˆ†æ
        function cancelAnalysis() {
            if (currentAnalysisTaskId) {
                currentAnalysisTaskId = null;
            }
            currentAnalysisTaskId = null;
            
            document.getElementById('smartAnalysis').innerHTML = 
                `<div class="cancelled">
                    <h3>ğŸ›‘ åˆ†æå·²å–æ¶ˆ</h3>
                    <p>æ‚¨å¯ä»¥éšæ—¶é‡æ–°å¼€å§‹åˆ†æ</p>
                    <button onclick="loadSmartAnalysis()" class="retry-btn">å¼€å§‹åˆ†æ</button>
                </div>`;
        }

        // æ›´æ–°åŸºç¡€åˆ†ææ˜¾ç¤º
        function updateBasicAnalysis(analysisData) {
            const container = document.getElementById('smartAnalysis');
            
            if (!analysisData) {
                container.innerHTML = '<div class="loading">æš‚æ— åˆ†ææ•°æ®</div>';
                return;
            }
            
            let html = `
                <div class="basic-analysis-container">
                    <div style="background: #e8f4fd; padding: 10px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #007bff;">
                        <h4 style="color: #007bff; margin: 0;">ğŸ“Š å¿«é€ŸæŠ•èµ„ç»„åˆåˆ†æ</h4>
                        <p style="margin: 5px 0 0 0; color: #666; font-size: 0.9em;">åŸºäºå½“å‰æ•°æ®çš„å³æ—¶åˆ†æï¼ŒAIæ·±åº¦åˆ†ææ­£åœ¨åŠ è½½ä¸­...</p>
                    </div>

                    <!-- æŠ•èµ„ç»„åˆæ¦‚è§ˆ -->
                    <div class="analysis-section" style="margin-bottom: 20px;">
                        <h4 style="color: #2c3e50; margin-bottom: 10px;">ğŸ’¼ æŠ•èµ„ç»„åˆæ¦‚è§ˆ</h4>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #28a745;">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                                <div>
                                    <strong>æ€»ä»·å€¼:</strong> $${analysisData.portfolio_overview.total_value.toFixed(2)} USDT<br>
                                    <strong>æ€»æˆæœ¬:</strong> $${analysisData.portfolio_overview.total_cost.toFixed(2)} USDT<br>
                                    <strong>ç›ˆäº:</strong> <span style="color: ${analysisData.portfolio_overview.total_pnl >= 0 ? '#28a745' : '#dc3545'}">
                                        $${analysisData.portfolio_overview.total_pnl.toFixed(2)} (${(analysisData.portfolio_overview.total_pnl_rate * 100).toFixed(2)}%)
                                    </span>
                                </div>
                                <div>
                                    <strong>æŒä»“æ•°é‡:</strong> ${analysisData.portfolio_overview.total_positions}<br>
                                    <strong>ç›ˆåˆ©æŒä»“:</strong> ${analysisData.portfolio_overview.profitable_positions}<br>
                                    <strong>äºæŸæŒä»“:</strong> ${analysisData.portfolio_overview.loss_positions}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- èµ„äº§é…ç½® -->
                    <div class="analysis-section" style="margin-bottom: 20px;">
                        <h4 style="color: #2c3e50; margin-bottom: 10px;">ğŸ¯ èµ„äº§é…ç½®</h4>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #007bff;">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
                                ${Object.entries(analysisData.asset_allocation).map(([asset, percentage]) => `
                                    <div style="text-align: center; padding: 10px; background: white; border-radius: 5px;">
                                        <strong>${asset}</strong><br>
                                        <span style="font-size: 1.2em; color: #007bff;">${percentage.toFixed(1)}%</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>

                    <!-- é£é™©è¯„ä¼° -->
                    <div class="analysis-section" style="margin-bottom: 20px;">
                        <h4 style="color: #2c3e50; margin-bottom: 10px;">âš ï¸ é£é™©è¯„ä¼°</h4>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #ffc107;">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                                <div>
                                    <strong>é£é™©ç­‰çº§:</strong> 
                                    <span style="padding: 3px 8px; border-radius: 4px; background: ${getRiskColor(analysisData.risk_assessment.risk_level)}; color: white;">
                                        ${analysisData.risk_assessment.risk_level}
                                    </span>
                                </div>
                                <div>
                                    <strong>å¤šæ ·åŒ–åˆ†æ•°:</strong> ${(analysisData.risk_assessment.diversification_score * 100).toFixed(1)}%<br>
                                    <div style="width: 100%; height: 8px; background: #e0e0e0; border-radius: 4px; margin-top: 5px;">
                                        <div style="width: ${analysisData.risk_assessment.diversification_score * 100}%; height: 100%; background: #28a745; border-radius: 4px;"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- åŸºç¡€å»ºè®® -->
                    ${analysisData.basic_suggestions && analysisData.basic_suggestions.length > 0 ? `
                    <div class="analysis-section" style="margin-bottom: 20px;">
                        <h4 style="color: #2c3e50; margin-bottom: 10px;">ğŸ’¡ åŸºç¡€å»ºè®®</h4>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #17a2b8;">
                            ${analysisData.basic_suggestions.map(suggestion => `
                                <div style="margin-bottom: 10px; padding: 10px; background: white; border-radius: 5px; border-left: 3px solid #17a2b8;">
                                    ${suggestion}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    ` : ''}

                    <!-- åˆ†ææ—¶é—´æˆ³ -->
                    <div style="text-align: center; margin-top: 20px; color: #666; font-size: 0.9em;">
                        åŸºç¡€åˆ†ææ—¶é—´: ${new Date(analysisData.analysis_timestamp).toLocaleString('zh-CN')}
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
        }

        // è·å–é£é™©ç­‰çº§é¢œè‰²
        function getRiskColor(riskLevel) {
            switch(riskLevel) {
                case 'ä½é£é™©': return '#28a745';
                case 'ä¸­ç­‰é£é™©': return '#ffc107';
                case 'ä¸­é«˜é£é™©': return '#fd7e14';
                case 'é«˜é£é™©': return '#dc3545';
                default: return '#6c757d';
            }
        }

        // åŠ è½½æ™ºèƒ½åˆ†æï¼ˆåŒæ­¥ç‰ˆæœ¬ï¼Œç”¨äºå¿«é€ŸæŸ¥çœ‹ï¼‰
        async function loadSmartAnalysisSync() {
            try {
                const container = document.getElementById('smartAnalysis');
                container.innerHTML = '<div class="loading">ğŸ”„ æ­£åœ¨è·å–åˆ†æ...</div>';
                
                const response = await fetch('/api/smart-analysis-sync');
                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.error || 'åˆ†æå¤±è´¥');
                }
                
                updateSmartAnalysis(result);
                
            } catch (error) {
                document.getElementById('smartAnalysis').innerHTML = 
                    `<div class="error">åŠ è½½å¤±è´¥: ${error.message}</div>`;
            }
        }

        // æ›´æ–°æ™ºèƒ½åˆ†ææ˜¾ç¤ºï¼ˆç®€åŒ–ç‰ˆæœ¬ï¼Œåç«¯å·²å¤„ç†æ ¼å¼åŒ–ï¼‰
        // é‡æ–°è®¾è®¡çš„Markdownè½¬HTMLå‡½æ•° - å¤„ç†å¤æ‚ç»“æ„
        function markdownToHtml(markdown) {
            if (!markdown) return '';
            
            // æ¸…ç†è¾“å…¥å¹¶æŒ‰è¡Œåˆ†å‰²
            let lines = markdown.trim().split('\n');
            let html = '';
            let inList = false;
            
            for (let i = 0; i < lines.length; i++) {
                let line = lines[i];
                let trimmedLine = line.trim();
                
                // è·³è¿‡ç©ºè¡Œ
                if (!trimmedLine) {
                    // å¦‚æœåœ¨åˆ—è¡¨ä¸­é‡åˆ°ç©ºè¡Œï¼Œç»“æŸåˆ—è¡¨
                    if (inList) {
                        html += '</ul>';
                        inList = false;
                    }
                    continue;
                }
                
                // å¤„ç†æ ‡é¢˜
                if (trimmedLine.startsWith('###')) {
                    if (inList) { html += '</ul>'; inList = false; }
                    const title = trimmedLine.replace(/^###\s*/, '');
                    html += `<h5 style="color: #495057; margin: 15px 0 8px 0; font-weight: bold; font-size: 1.05em; border-bottom: 1px solid #e9ecef; padding-bottom: 4px;">${formatInlineText(title)}</h5>`;
                }
                else if (trimmedLine.startsWith('##')) {
                    if (inList) { html += '</ul>'; inList = false; }
                    const title = trimmedLine.replace(/^##\s*/, '');
                    html += `<h4 style="color: #343a40; margin: 18px 0 10px 0; font-weight: bold; font-size: 1.1em; border-bottom: 2px solid #dee2e6; padding-bottom: 6px;">${formatInlineText(title)}</h4>`;
                }
                else if (trimmedLine.startsWith('#')) {
                    if (inList) { html += '</ul>'; inList = false; }
                    const title = trimmedLine.replace(/^#\s*/, '');
                    html += `<h3 style="color: #212529; margin: 20px 0 12px 0; font-weight: bold; font-size: 1.2em; border-bottom: 3px solid #007bff; padding-bottom: 8px;">${formatInlineText(title)}</h3>`;
                }
                // å¤„ç†æ•°å­—æ ‡é¢˜ (å¦‚ "1. **USDTä½™é¢é…ç½®å»ºè®®**ï¼š")
                else if (/^\d+\.\s+/.test(trimmedLine)) {
                    if (inList) { html += '</ul>'; inList = false; }
                    html += `<h5 style="color: #495057; margin: 12px 0 8px 0; font-weight: bold; font-size: 1.05em; background: #f8f9fa; padding: 8px 12px; border-left: 4px solid #007bff; border-radius: 4px;">${formatInlineText(trimmedLine)}</h5>`;
                }
                // å¤„ç†emojiå¼€å¤´çš„ä¸»æ ‡é¢˜
                else if (/^(ğŸ“Š|ğŸ“ˆ|ğŸ¯|ğŸ’¼|âš¡|âš ï¸|ğŸ’¡|ğŸ“‹|ğŸ¤–|ğŸ’°|ğŸ”|ğŸ“Œ|âš–ï¸|ğŸš€|ğŸ›¡ï¸|âœ…|ğŸŸ¡|ğŸŸ¢|ğŸ”½|ğŸ”¼|ğŸ“‰|ğŸ“ˆ|ğŸŸ¢)\s+/.test(trimmedLine)) {
                    if (inList) { html += '</ul>'; inList = false; }
                    html += `<h4 style="color: #2c3e50; margin: 14px 0 8px 0; font-weight: bold; font-size: 1.05em; background: linear-gradient(90deg, #f8f9fa, #ffffff); padding: 10px 15px; border-left: 4px solid #28a745; border-radius: 6px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">${formatInlineText(trimmedLine)}</h4>`;
                }
                // å¤„ç†åˆ—è¡¨é¡¹ï¼ˆåŒ…æ‹¬æœ‰ç¼©è¿›çš„ï¼‰
                else if (trimmedLine.startsWith('- ') || trimmedLine.startsWith('* ') || trimmedLine.startsWith('+ ')) {
                    if (!inList) {
                        html += '<ul style="margin: 8px 0; padding-left: 20px; list-style-type: disc;">';
                        inList = true;
                    }
                    const content = trimmedLine.replace(/^[-*+]\s+/, '');
                    html += `<li style="margin: 4px 0; padding-left: 8px; color: #495057; line-height: 1.5;">${formatInlineText(content)}</li>`;
                }
                // å¤„ç†ç¼©è¿›çš„æ–‡æœ¬ï¼ˆå¯èƒ½æ˜¯å­é¡¹ï¼‰
                else if (line.startsWith('  ') || line.startsWith('\t')) {
                    // å¦‚æœå½“å‰æ²¡æœ‰åœ¨åˆ—è¡¨ä¸­ï¼Œä½†è¿™æ˜¯ç¼©è¿›æ–‡æœ¬ï¼Œä½œä¸ºå­é¡¹å¤„ç†
                    if (!inList) {
                        html += '<ul style="margin: 8px 0; padding-left: 20px; list-style-type: disc;">';
                        inList = true;
                    }
                    html += `<li style="margin: 4px 0; padding-left: 8px; color: #495057; line-height: 1.5;">${formatInlineText(trimmedLine)}</li>`;
                }
                // å¤„ç†æ™®é€šæ®µè½
                else {
                    if (inList) { html += '</ul>'; inList = false; }
                    html += `<p style="margin: 8px 0; line-height: 1.6; color: #495057; font-size: 0.95em;">${formatInlineText(trimmedLine)}</p>`;
                }
            }
            
            // ç¡®ä¿æœ€åå…³é—­åˆ—è¡¨
            if (inList) {
                html += '</ul>';
            }
            
            return html;
        }
        
        // å¤„ç†è¡Œå†…æ ¼å¼ï¼ˆç²—ä½“ã€æ–œä½“ç­‰ï¼‰
        function formatInlineText(text) {
            return text
                // å¤„ç†ç²—ä½“
                .replace(/\*\*(.*?)\*\*/g, '<strong style="color: #2c3e50; font-weight: 600; background: #fff3cd; padding: 2px 4px; border-radius: 3px;">$1</strong>')
                // å¤„ç†æ–œä½“
                .replace(/\*(.*?)\*/g, '<em style="color: #495057; font-style: italic;">$1</em>')
                // å¤„ç†ä»£ç 
                .replace(/`(.*?)`/g, '<code style="background: #f1f3f4; padding: 2px 4px; border-radius: 3px; font-family: monospace;">$1</code>')
                // å¤„ç†ä»·æ ¼ï¼ˆå¦‚ $113,500ï¼‰
                .replace(/\$([0-9,]+(?:\.[0-9]+)?)/g, '<span style="color: #007bff; font-weight: 600;">$$$1</span>')
                // å¤„ç†ç™¾åˆ†æ¯”
                .replace(/([0-9]+(?:\.[0-9]+)?)%/g, '<span style="color: #28a745; font-weight: 600;">$1%</span>');
        }

        function updateSmartAnalysis(analysisData) {
            const container = document.getElementById('smartAnalysis');
            
            if (!analysisData) {
                container.innerHTML = '<div class="loading">æš‚æ— åˆ†ææ•°æ®</div>';
                return;
            }
            
            // å¦‚æœæœ‰åŸå§‹AIå“åº”ï¼Œç›´æ¥æ˜¾ç¤º
            if (analysisData.ai_response) {
                let html = `
                    <div class="analysis-container">
                        <!-- AIç½®ä¿¡åº¦æŒ‡ç¤ºå™¨ -->
                        <div class="confidence-indicator" style="margin-bottom: 20px;">
                            <span style="font-weight: bold;">AIåˆ†æç½®ä¿¡åº¦:</span>
                            <div class="confidence-bar" style="display: inline-block; width: 100px; height: 20px; background: #f0f0f0; border-radius: 10px; margin-left: 10px; position: relative;">
                                <div style="width: ${(analysisData.ai_confidence * 100)}%; height: 100%; background: linear-gradient(90deg, #28a745, #ffc107, #dc3545); border-radius: 10px;"></div>
                            </div>
                            <span style="margin-left: 10px; font-weight: bold;">${(analysisData.ai_confidence * 100).toFixed(1)}%</span>
                        </div>

                        <!-- åŸå§‹AIåˆ†æå†…å®¹ -->
                        <div class="analysis-section" style="margin-bottom: 20px;">
                            <h4 style="color: #2c3e50; margin-bottom: 10px;">ğŸ¤– OpenAI AI æŠ•èµ„åˆ†æ</h4>
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #007bff; line-height: 1.6; font-size: 0.95em;">
                                ${analysisData.ai_response}
                            </div>
                        </div>

                        <!-- åˆ†ææ—¶é—´æˆ³ -->
                        <div style="text-align: center; margin-top: 20px; color: #666; font-size: 0.9em;">
                            åˆ†ææ—¶é—´: ${new Date(analysisData.analysis_timestamp).toLocaleString('zh-CN')}
                        </div>
                    </div>
                `;
                container.innerHTML = html;
                return;
            }
            
            // å…¼å®¹æ—§æ ¼å¼ï¼šå¦‚æœæ²¡æœ‰ai_responseä½†æœ‰å…¶ä»–å­—æ®µï¼Œæ˜¾ç¤ºåˆ†æ®µæ ¼å¼
            if (analysisData.market_analysis || analysisData.portfolio_review || analysisData.trading_signals || analysisData.risk_assessment) {
                let html = `
                    <div class="analysis-container">
                        <!-- AIç½®ä¿¡åº¦æŒ‡ç¤ºå™¨ -->
                        <div class="confidence-indicator" style="margin-bottom: 20px;">
                            <span style="font-weight: bold;">åˆ†æç½®ä¿¡åº¦:</span>
                            <div class="confidence-bar" style="display: inline-block; width: 100px; height: 20px; background: #f0f0f0; border-radius: 10px; margin-left: 10px; position: relative;">
                                <div style="width: ${(analysisData.ai_confidence * 100)}%; height: 100%; background: linear-gradient(90deg, #28a745, #ffc107, #dc3545); border-radius: 10px;"></div>
                            </div>
                            <span style="margin-left: 10px; font-weight: bold;">${(analysisData.ai_confidence * 100).toFixed(1)}%</span>
                        </div>

                        
                        <!-- é£é™©è¯„ä¼° -->
                        ${analysisData.risk_assessment ? `
                        <div class="analysis-section" style="margin-bottom: 20px;">
                            <h4 style="color: #2c3e50; margin-bottom: 10px;">ğŸ“Š  å¸‚åœºè¶‹åŠ¿åˆ†æ</h4>
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #dc3545; line-height: 1.6;">
                                ${analysisData.risk_assessment}
                            </div>
                        </div>
                        ` : ''}

                        <!-- å¸‚åœºåˆ†æ -->
                        ${analysisData.market_analysis ? `
                        <div class="analysis-section" style="margin-bottom: 20px;">
                            <h4 style="color: #2c3e50; margin-bottom: 10px;">ğŸ“Š å¸ç§åˆ†æ</h4>
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #007bff; line-height: 1.6;">
                                ${analysisData.market_analysis}
                            </div>
                        </div>
                        ` : ''}

                        <!-- åˆ†ææ—¶é—´æˆ³ -->
                        <div style="text-align: center; margin-top: 20px; color: #666; font-size: 0.9em;">
                            åˆ†ææ—¶é—´: ${new Date(analysisData.analysis_timestamp).toLocaleString('zh-CN')}
                        </div>
                    </div>
                `;
                
                container.innerHTML = html;
                return;
            }
            
            // å¦‚æœæ²¡æœ‰ä»»ä½•æœ‰æ•ˆæ•°æ®
            container.innerHTML = '<div class="loading">æš‚æ— åˆ†ææ•°æ®</div>';
        }

        // è·å–æ“ä½œé¢œè‰²
        function getActionColor(action) {
            switch(action) {
                case 'BUY': return '#28a745';
                case 'SELL': return '#dc3545';
                case 'HOLD': return '#ffc107';
                default: return '#6c757d';
            }
        }

        // è·å–æ“ä½œæ–‡æœ¬
        function getActionText(action) {
            switch(action) {
                case 'BUY': return 'ä¹°å…¥';
                case 'SELL': return 'å–å‡º';
                case 'HOLD': return 'æŒæœ‰';
                default: return action;
            }
        }

        // ä¿æŒå‘åå…¼å®¹çš„AIå»ºè®®åŠ è½½å‡½æ•°
        async function loadRecommendations() {
            return loadSmartAnalysis();
        }

        // åŠ è½½è®¢å•ä¿¡æ¯
        async function loadOrders() {
            try {
                const response = await fetch('/api/orders');
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                updateOpenOrders(data.open_orders);
                
            } catch (error) {
                document.getElementById('openOrders').innerHTML = 
                    `<div class="error">åŠ è½½å¤±è´¥: ${error.message}</div>`;
            }
        }

        // æ›´æ–°æœªå®Œæˆè®¢å•
        function updateOpenOrders(orders) {
            const container = document.getElementById('openOrders');
            
            if (!orders || orders.length === 0) {
                container.innerHTML = '<div class="loading">æš‚æ— æœªå®Œæˆè®¢å•</div>';
                return;
            }
            
            let html = '<table class="table"><tr><th>äº¤æ˜“å¯¹</th><th>ç±»å‹</th><th>æ•°é‡</th><th>ä»·æ ¼</th><th>çŠ¶æ€</th></tr>';
            
            orders.forEach(order => {
                const sideClass = order.side === 'buy' ? 'positive' : 'negative';
                const sideText = order.side === 'buy' ? 'ä¹°å…¥' : 'å–å‡º';
                
                // ç¡®å®šè®¢å•ç±»å‹æ˜¾ç¤ºæ–‡æœ¬
                let typeText = 'é™ä»·';
                let statusText = 'ç­‰å¾…æˆäº¤';
                let statusColor = '#007bff';
                
                const orderType = order.type?.toLowerCase() || '';
                
                if (orderType === 'market') {
                    typeText = 'å¸‚ä»·';
                } else if (orderType.includes('stop')) {
                    typeText = order.side === 'buy' ? 'æ­¢æŸä¹°å…¥' : 'æ­¢æŸå–å‡º';
                    statusText = 'å¾…è§¦å‘';
                    statusColor = '#ffc107';
                } else if (orderType.includes('take_profit')) {
                    typeText = 'æ­¢ç›ˆ';
                    statusText = 'å¾…è§¦å‘';
                    statusColor = '#ffc107';
                } else if (orderType.includes('oco')) {
                    typeText = 'OCOè®¢å•';
                    statusText = 'å¾…è§¦å‘';
                    statusColor = '#ffc107';
                } else if (orderType.includes('trigger')) {
                    typeText = 'è§¦å‘è®¢å•';
                    statusText = 'å¾…è§¦å‘';
                    statusColor = '#ffc107';
                } else if (orderType.includes('conditional')) {
                    typeText = 'æ¡ä»¶è®¢å•';
                    statusText = 'å¾…è§¦å‘';
                    statusColor = '#ffc107';
                }
                
                // æ™ºèƒ½æ ¼å¼åŒ–æ•°é‡æ˜¾ç¤º
                function formatAmount(amount, symbol) {
                    const amt = parseFloat(amount);
                    
                    // æ ¹æ®å¸ç§å’Œæ•°é‡å¤§å°å†³å®šç²¾åº¦
                    if (symbol.includes('BTC')) {
                        return amt.toFixed(6); // BTCä¿ç•™6ä½å°æ•°
                    } else if (symbol.includes('ETH')) {
                        return amt.toFixed(4); // ETHä¿ç•™4ä½å°æ•°
                    } else if (symbol.includes('ADA')) {
                        return amt.toFixed(0); // ADAç­‰å°ä»·å€¼å¸ç§ä¿ç•™æ•´æ•°
                    } else if (amt < 1) {
                        return amt.toFixed(6); // å°äº1çš„æ•°é‡ä¿ç•™6ä½
                    } else if (amt < 100) {
                        return amt.toFixed(3); // 1-100ä¿ç•™3ä½
                    } else {
                        return amt.toFixed(0); // å¤§äº100ä¿ç•™æ•´æ•°
                    }
                }
                
                // æ™ºèƒ½æ ¼å¼åŒ–ä»·æ ¼æ˜¾ç¤º
                function formatPrice(price) {
                    if (!price) return 'å¸‚ä»·';
                    
                    const p = parseFloat(price);
                    
                    if (p >= 1000) {
                        return p.toLocaleString('en-US', {minimumFractionDigits: 0, maximumFractionDigits: 0});
                    } else if (p >= 1) {
                        return p.toFixed(2);
                    } else {
                        return p.toFixed(4);
                    }
                }
                
                const formattedAmount = formatAmount(order.amount, order.symbol);
                const formattedPrice = formatPrice(order.price);
                
                html += `
                    <tr>
                        <td>${order.symbol}</td>
                        <td class="${sideClass}">${sideText} ${typeText}</td>
                        <td>${formattedAmount}</td>
                        <td>$${formattedPrice}</td>
                        <td><span style="color: ${statusColor};">${statusText}</span></td>
                    </tr>
                `;
            });
            
            html += '</table>';
            container.innerHTML = html;
        }

        // åŠ è½½äº¤æ˜“è®°å½•
        async function loadTrades() {
            try {
                const response = await fetch('/api/trades');
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                updateRecentTrades(data.trades);
                
            } catch (error) {
                document.getElementById('recentTrades').innerHTML = 
                    `<div class="error">åŠ è½½å¤±è´¥: ${error.message}</div>`;
            }
        }

        // æ›´æ–°æœ€è¿‘äº¤æ˜“
        function updateRecentTrades(trades) {
            const container = document.getElementById('recentTrades');
            
            if (!trades || trades.length === 0) {
                container.innerHTML = '<div class="loading">æš‚æ— äº¤æ˜“è®°å½•</div>';
                return;
            }
            
            let html = '<table class="table"><tr><th>äº¤æ˜“å¯¹</th><th>ç±»å‹</th><th>æ•°é‡</th><th>ä»·æ ¼</th></tr>';
            
            trades.slice(0, 10).forEach(trade => {
                // æ ¼å¼åŒ–æ•°é‡ï¼Œæœ€å¤šæ˜¾ç¤º6ä½å°æ•°
                const formattedAmount = parseFloat(trade.amount).toFixed(6).replace(/\.?0+$/, '');
                
                html += `
                    <tr>
                        <td>${trade.symbol}</td>
                        <td class="${trade.side === 'buy' ? 'positive' : 'negative'}">${trade.side}</td>
                        <td>${formattedAmount}</td>
                        <td>$${trade.price?.toFixed(2)}</td>
                    </tr>
                `;
            });
            
            html += '</table>';
            container.innerHTML = html;
        }

        // æ›´æ–°æŠ•èµ„ç»„åˆå›¾è¡¨
        function updatePortfolioChart(historyData) {
            const ctx = document.getElementById('portfolioChart').getContext('2d');
            
            // å¦‚æœå›¾è¡¨å·²å­˜åœ¨ï¼Œå…ˆé”€æ¯
            if (portfolioChart) {
                portfolioChart.destroy();
            }
            
            const history = historyData.history || [];
            
            if (history.length === 0) {
                ctx.fillStyle = '#666';
                ctx.textAlign = 'center';
                ctx.font = '16px Arial';
                ctx.fillText('æš‚æ— å†å²æ•°æ®', ctx.canvas.width / 2, ctx.canvas.height / 2);
                return;
            }
            
            // å‡†å¤‡å›¾è¡¨æ•°æ®
            const labels = history.map(item => {
                const date = new Date(item.date);
                return `${date.getMonth() + 1}/${date.getDate()}`;
            });
            
            const totalValueData = history.map(item => item.total_value);
            const returnRateData = history.map(item => item.return_rate);
            
            // åˆ›å»ºçº¿å›¾æ˜¾ç¤ºæŠ•èµ„ç»„åˆä»·å€¼èµ°åŠ¿
            portfolioChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'æŠ•èµ„ç»„åˆæ€»ä»·å€¼ ($)',
                        data: totalValueData,
                        borderColor: '#2196F3',
                        backgroundColor: 'rgba(33, 150, 243, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4,
                        yAxisID: 'y'
                    }, 
                    // {
                    //     label: 'æ”¶ç›Šç‡ (%)',
                    //     data: returnRateData,
                    //     borderColor: '#4CAF50',
                    //     backgroundColor: 'rgba(76, 175, 80, 0.1)',
                    //     borderWidth: 2,
                    //     fill: false,
                    //     tension: 0.4,
                    //     yAxisID: 'y1'
                    // }
                ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    scales: {
                        x: {
                            display: true,
                            title: {
                                display: true,
                                text: 'æ—¥æœŸ'
                            }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'æŠ•èµ„ç»„åˆä»·å€¼ ($)'
                            },
                            grid: {
                                drawOnChartArea: true,
                            },
                        },
                        // y1: {
                        //     type: 'linear',
                        //     display: true,
                        //     position: 'right',
                        //     title: {
                        //         display: true,
                        //         text: 'æ”¶ç›Šç‡ (%)'
                        //     },
                        //     grid: {
                        //         drawOnChartArea: false,
                        //     },
                        // }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            callbacks: {
                                title: function(context) {
                                    const index = context[0].dataIndex;
                                    return history[index].date;
                                },
                                label: function(context) {
                                    const value = context.raw;
                                    if (context.datasetIndex === 0) {
                                        return `æ€»ä»·å€¼: $${value.toFixed(2)}`;
                                    } else {
                                        const index = context.dataIndex;
                                        const returnRate = history[index].return_rate;
                                        return `æ”¶ç›Šç‡: ${returnRate.toFixed(2)}%`;
                                    }
                                }
                            }
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>
