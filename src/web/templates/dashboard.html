<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½åŠ å¯†è´§å¸æŠ•èµ„åŠ©æ‰‹</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            position: relative;
        }

        .github-link {
            position: absolute;
            top: 20px;
            right: 20px;
            color: white;
            text-decoration: none;
            font-size: 24px;
            transition: transform 0.3s ease, opacity 0.3s ease;
            z-index: 10;
        }

        .github-link:hover {
            transform: scale(1.2);
            opacity: 0.8;
            color: #f0f0f0;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .smart-analysis-section {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .chart-section {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .portfolio-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .orders-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .card-title {
            font-size: 1.3em;
            margin-bottom: 15px;
            color: #333;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 10px;
        }

        .metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .metric:last-child {
            border-bottom: none;
        }

        .metric-label {
            color: #666;
        }

        .metric-value {
            font-weight: bold;
            font-size: 1.1em;
        }

        .positive {
            color: #4CAF50;
        }

        .negative {
            color: #f44336;
        }

        .recommendation {
            border-left: 4px solid #2196F3;
            padding: 15px;
            margin: 10px 0;
            background: #f8f9ff;
            border-radius: 5px;
        }

        .recommendation.buy {
            border-left-color: #4CAF50;
            background: #f8fff8;
        }

        .recommendation.sell {
            border-left-color: #f44336;
            background: #fff8f8;
        }

        .recommendation.hold {
            border-left-color: #ff9800;
            background: #fffdf8;
        }

        .recommendation-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .recommendation-symbol {
            font-weight: bold;
            font-size: 1.2em;
        }

        .recommendation-action {
            padding: 5px 15px;
            border-radius: 20px;
            color: white;
            font-weight: bold;
            text-transform: uppercase;
        }

        .action-buy {
            background: #4CAF50;
        }

        .action-sell {
            background: #f44336;
        }

        .action-hold {
            background: #ff9800;
        }

        .confidence-bar {
            width: 100%;
            height: 10px;
            background: #e0e0e0;
            border-radius: 5px;
            overflow: hidden;
            margin: 10px 0;
        }

        .confidence-fill {
            height: 100%;
            background: linear-gradient(90deg, #f44336, #ff9800, #4CAF50);
            transition: width 0.3s ease;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 0.9em; /* å‡å°å­—ä½“å¤§å° */
            overflow-x: auto; /* å…è®¸æ°´å¹³æ»šåŠ¨ */
        }

        .table th,
        .table td {
            padding: 8px 6px; /* å‡å°å†…è¾¹è· */
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
            white-space: nowrap; /* é˜²æ­¢æ–‡å­—æ¢è¡Œ */
        }

        .table th {
            background: #f5f5f5;
            font-weight: bold;
            color: #333;
            font-size: 0.85em; /* è¡¨å¤´å­—ä½“æ›´å° */
        }

        .table tr:hover {
            background: #f9f9f9;
        }

        /* æŒä»“è¯¦æƒ…è¡¨æ ¼çš„ç‰¹æ®Šæ ·å¼ */
        #positions .table {
            font-size: 0.8em; /* æŒä»“è¡¨æ ¼å­—ä½“æ›´å° */
        }

        #positions .table th,
        #positions .table td {
            padding: 6px 4px; /* æŒä»“è¡¨æ ¼å†…è¾¹è·æ›´å° */
        }

        /* ä¸ºè¡¨æ ¼æ·»åŠ æ»šåŠ¨å®¹å™¨ */
        .table-container {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch; /* iOSå¹³æ»‘æ»šåŠ¨ */
        }

        /* å“åº”å¼ä¼˜åŒ– */
        @media (max-width: 768px) {
            .table {
                font-size: 0.75em;
            }
            
            .table th,
            .table td {
                padding: 4px 2px;
            }
            
            #positions .table {
                font-size: 0.7em;
            }
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 20px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .error {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            border-left: 4px solid #c62828;
        }

        .refresh-btn {
            background: #2196F3;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            transition: background 0.3s ease;
        }

        .refresh-btn:hover {
            background: #1976D2;
        }

        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        .status-online {
            background: #4CAF50;
            box-shadow: 0 0 10px rgba(76, 175, 80, 0.5);
        }

        .status-offline {
            background: #f44336;
            box-shadow: 0 0 10px rgba(244, 67, 54, 0.5);
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.3; }
        }

        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .smart-analysis-section {
                grid-template-columns: 1fr;
            }
            
            .chart-section {
                grid-template-columns: 1fr;
            }
            
            .portfolio-section {
                grid-template-columns: 1fr;
            }
            
            .orders-section {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .container {
                padding: 10px;
            }

            .github-link {
                top: 15px;
                right: 15px;
                font-size: 20px;
            }
            
            /* AIåˆ†æå¡ç‰‡ç‰¹æ®Šä¼˜åŒ– */
            .card:has(.analysis-container),
            .card:has(.basic-analysis-container) {
                padding: 8px !important;
                margin: 10px 5px !important;
            }
            
            .card h3 {
                font-size: 1.1em;
                margin-bottom: 10px;
                padding: 0 5px;
            }

            /* AIåˆ†æå†…å®¹ç§»åŠ¨ç«¯ä¼˜åŒ– */
            .analysis-container {
                word-wrap: break-word;
                overflow-wrap: break-word;
                max-width: 100%;
                width: 100% !important;
                padding: 0 5px !important;
            }

            .analysis-section {
                margin-bottom: 15px !important;
                width: 100% !important;
            }

            .analysis-section div {
                padding: 15px !important;
                font-size: 0.9em !important;
                word-wrap: break-word;
                overflow-wrap: break-word;
                hyphens: auto;
                width: 100% !important;
                box-sizing: border-box !important;
            }

            .confidence-indicator {
                flex-wrap: wrap;
                margin-bottom: 15px !important;
                display: flex !important;
                flex-direction: row !important;
                align-items: center !important;
                gap: 10px !important;
                width: 100% !important;
            }

            .confidence-indicator span {
                font-size: 0.9em;
                margin: 0;
                flex-shrink: 0;
            }

            .confidence-bar {
                flex: 1 !important;
                min-width: 80px !important;
                max-width: 120px !important;
                margin: 0 !important;
            }

            /* åŸºç¡€åˆ†æå®¹å™¨ä¼˜åŒ– */
            .basic-analysis-container {
                max-width: 100%;
                overflow-x: hidden;
                width: 100% !important;
                padding: 0 5px !important;
            }

            .basic-analysis-container div[style*="grid"] {
                display: block !important;
                grid-template-columns: none !important;
                width: 100% !important;
            }

            .basic-analysis-container div[style*="grid"] > div {
                margin-bottom: 10px;
                padding: 12px;
                font-size: 0.9em;
                width: 100% !important;
                box-sizing: border-box !important;
            }

            /* é•¿æ–‡æœ¬å†…å®¹ä¼˜åŒ– */
            h3, h4, h5 {
                font-size: 1em !important;
                line-height: 1.3;
                margin: 10px 0 5px 0 !important;
                word-wrap: break-word;
            }

            /* ç»Ÿè®¡ä¿¡æ¯æ–‡æœ¬ä¼˜åŒ– */
            div[style*="text-align: center"] {
                font-size: 0.8em !important;
                line-height: 1.4;
                padding: 0 5px;
            }

            /* é˜²æ­¢ä»£ç æˆ–é•¿å•è¯æº¢å‡º */
            code, pre {
                word-break: break-all;
                white-space: pre-wrap;
                max-width: 100%;
                overflow-x: auto;
            }

            /* è¡¨æ ¼åœ¨AIåˆ†æä¸­çš„ä¼˜åŒ– */
            .analysis-container .table-container {
                font-size: 0.7em;
            }
        }

        /* AIåˆ†æå†…å®¹æ ·å¼ä¼˜åŒ– */
        .analysis-container {
            max-width: 100%;
            overflow-x: hidden;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .analysis-section {
            max-width: 100%;
            overflow-x: hidden;
        }

        .analysis-section div {
            max-width: 100%;
            overflow-x: hidden;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        /* é˜²æ­¢é•¿URLæˆ–ä»£ç å—æº¢å‡º */
        .analysis-container p,
        .analysis-container div,
        .analysis-container span {
            word-break: break-word;
            overflow-wrap: break-word;
            hyphens: auto;
        }

        /* å¼‚æ­¥åˆ†ææ ·å¼ */
        .analysis-loading {
            text-align: center;
            padding: 40px 20px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 15px;
            border: 2px dashed #6c757d;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
            margin: 20px 0;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #28a745, #20c997, #17a2b8);
            border-radius: 10px;
            transition: width 0.5s ease;
            position: relative;
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent 33%, rgba(255,255,255,0.3) 33%, rgba(255,255,255,0.3) 66%, transparent 66%);
            background-size: 30px 30px;
            animation: progressStripe 1s linear infinite;
        }

        @keyframes progressStripe {
            0% { background-position: 0 0; }
            100% { background-position: 30px 0; }
        }

        .progress-text {
            font-size: 0.9em;
            color: #6c757d;
            margin-top: 10px;
        }

        .cancel-btn, .retry-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 15px;
            font-size: 0.9em;
            transition: background 0.3s ease;
        }

        .retry-btn {
            background: #28a745;
        }

        .cancel-btn:hover {
            background: #c82333;
        }

        .retry-btn:hover {
            background: #1e7e34;
        }

        .error {
            text-align: center;
            padding: 30px;
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 10px;
            color: #721c24;
        }

        .cancelled {
            text-align: center;
            padding: 30px;
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 10px;
            color: #856404;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #6c757d;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <a href="https://github.com/2024baibai/crypto_invest_with_ai" target="_blank" class="github-link" title="GitHub Repository">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
                </svg>
            </a>
            <h1>ğŸ¤– æ™ºèƒ½åŠ å¯†è´§å¸æŠ•èµ„åŠ©æ‰‹</h1>
            <p>æ™ºèƒ½åˆ†æ Â· ç²¾å‡†å»ºè®® Â· ç¨³å¥æŠ•èµ„</p>
            <div style="margin-top: 15px;">
                <span class="status-indicator" id="statusIndicator"></span>
                <span id="statusText">è¿æ¥ä¸­...</span>
                <span id="wsStatus" style="margin-left: 20px; font-size: 0.9em; color: #666;"></span>
                <button class="refresh-btn" onclick="refreshAllData()" style="margin-left: 20px;">åˆ·æ–°æ•°æ®</button>
                <button class="refresh-btn" onclick="saveSnapshot()" style="margin-left: 10px;">ä¿å­˜å¿«ç…§</button>
                <button class="refresh-btn" onclick="toggleWebSocket()" style="margin-left: 10px;" id="wsToggleBtn">é‡è¿WS</button>
            </div>
        </div>

        <!-- ç¬¬ä¸€è¡Œï¼šæŠ•èµ„ç»„åˆè¡¨ç°å›¾è¡¨ -->
        <div class="chart-section">
            <div class="card">
                <div class="card-title">ğŸ“ˆ æŠ•èµ„ç»„åˆè¡¨ç°</div>
                <div class="chart-container">
                    <canvas id="portfolioChart"></canvas>
                </div>
            </div>
        </div>

        <!-- ç¬¬ä¸‰è¡Œï¼šæŠ•èµ„ç»„åˆæ¦‚è§ˆã€å¸‚åœºæ•°æ®ã€æŒä»“è¯¦æƒ… -->
        <div class="portfolio-section">
            <!-- æŠ•èµ„ç»„åˆæ¦‚è§ˆ -->
            <div class="card">
                <div class="card-title">ğŸ“Š æŠ•èµ„ç»„åˆæ¦‚è§ˆ</div>
                <div id="portfolioOverview">
                    <div class="loading">åŠ è½½ä¸­...</div>
                </div>
            </div>

            <!-- å¸‚åœºæ•°æ® -->
            <div class="card">
                <div class="card-title">ğŸ“ˆ å¸‚åœºæ•°æ®</div>
                <div id="marketData">
                    <div class="loading">åŠ è½½ä¸­...</div>
                </div>
            </div>

            <!-- æŒä»“è¯¦æƒ… -->
            <div class="card">
                <div class="card-title">ğŸ’° æŒä»“è¯¦æƒ…</div>
                <div id="positions">
                    <div class="loading">åŠ è½½ä¸­...</div>
                </div>
            </div>
        </div>

        <!-- ç¬¬ä¸‰è¡Œï¼šè®¢å•ä¿¡æ¯ -->
        <div class="orders-section">
            <div class="card">
                <div class="card-title">ğŸ“‹ æœªå®Œæˆè®¢å•</div>
                <div id="openOrders">
                    <div class="loading">åŠ è½½ä¸­...</div>
                </div>
            </div>

            <div class="card">
                <div class="card-title">ğŸ”„ æœ€è¿‘äº¤æ˜“</div>
                <div id="recentTrades">
                    <div class="loading">åŠ è½½ä¸­...</div>
                </div>
            </div>
        </div>

        <!-- ç¬¬å››è¡Œï¼šæ™ºèƒ½æŠ•èµ„åˆ†æï¼ˆç§»åˆ°æœ€ä¸‹æ–¹ï¼‰ -->
        <div class="smart-analysis-section">
            <div class="card">
                <div class="card-title">
                    ğŸ§  OpenAIæ™ºèƒ½æŠ•èµ„åˆ†æ
                    <div style="float: right; font-size: 0.8em;">
                        <button onclick="loadSmartAnalysis(true)" class="refresh-btn" title="å¼ºåˆ¶åˆ·æ–°åˆ†æ">
                            ğŸ”„ é‡æ–°åˆ†æ
                        </button>
                    </div>
                </div>
                <div id="smartAnalysis">
                    <div class="loading">ç­‰å¾…åˆ†æ...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let portfolioChart = null;
        let currentAnalysisTaskId = null; // å½“å‰åˆ†æä»»åŠ¡ID
        let socket = null; // WebSocketè¿æ¥
        let pendingForceRefresh = false; // è®°å½•å¾…å¤„ç†çš„å¼ºåˆ¶åˆ·æ–°çŠ¶æ€
        let lastDataRequestTime = 0; // è®°å½•æœ€åä¸€æ¬¡æ•°æ®è¯·æ±‚æ—¶é—´

        // åˆå§‹åŒ–WebSocketè¿æ¥
        function initWebSocket() {
            // é…ç½®Socket.IOé€‰é¡¹ä»¥ä¼˜åŒ–è¿æ¥
            socket = io({
                transports: ['websocket', 'polling'], // ä¼˜å…ˆä½¿ç”¨websocket
                upgrade: true, // å…è®¸å‡çº§åˆ°websocket
                rememberUpgrade: true, // è®°ä½å‡çº§çŠ¶æ€
                timeout: 10000, // è¿æ¥è¶…æ—¶æ—¶é—´
                reconnection: true, // è‡ªåŠ¨é‡è¿
                reconnectionDelay: 2000, // é‡è¿å»¶è¿Ÿ
                reconnectionDelayMax: 10000, // æœ€å¤§é‡è¿å»¶è¿Ÿ
                maxReconnectionAttempts: 5, // æœ€å¤§é‡è¿æ¬¡æ•°
                forceNew: false // ä¸å¼ºåˆ¶åˆ›å»ºæ–°è¿æ¥
            });
            
            // è¿æ¥æˆåŠŸäº‹ä»¶
            socket.on('connect', function() {
                console.log('WebSocketè¿æ¥æˆåŠŸï¼Œä¼ è¾“æ–¹å¼:', socket.io.engine.transport.name);
                updateStatus('online');
                // è¯·æ±‚åˆå§‹æ•°æ®ï¼ˆåŒ…å«åŸºç¡€åˆ†æï¼‰
                socket.emit('request_data', {type: 'all'});
                lastDataRequestTime = Date.now(); // è®°å½•è¯·æ±‚æ—¶é—´
            });
            
            // ä¼ è¾“å‡çº§äº‹ä»¶
            socket.io.on('upgrade', function() {
                console.log('è¿æ¥å·²å‡çº§åˆ°WebSocket');
            });
            
            // è¿æ¥æ–­å¼€äº‹ä»¶
            socket.on('disconnect', function(reason) {
                console.log('WebSocketè¿æ¥æ–­å¼€ï¼ŒåŸå› :', reason);
                updateStatus('offline');
            });
            
            // æŠ•èµ„ç»„åˆæ•°æ®æ›´æ–°
            socket.on('portfolio_update', function(data) {
                console.log('æ”¶åˆ°æŠ•èµ„ç»„åˆæ•°æ®æ›´æ–°', data);
                updatePortfolioOverview(data);
                updatePositions(data.positions);
            });
            
            // å¸‚åœºæ•°æ®æ›´æ–°
            socket.on('market_update', function(data) {
                console.log('æ”¶åˆ°å¸‚åœºæ•°æ®æ›´æ–°', data);
                updateMarketData(data.market_data);
            });
            
            // è®¢å•æ•°æ®æ›´æ–°
            socket.on('orders_update', function(data) {
                console.log('æ”¶åˆ°è®¢å•æ•°æ®æ›´æ–°', data);
                updateOpenOrders(data.open_orders);
            });
            
            // äº¤æ˜“æ•°æ®æ›´æ–°
            socket.on('trades_update', function(data) {
                console.log('æ”¶åˆ°äº¤æ˜“æ•°æ®æ›´æ–°', data);
                updateRecentTrades(data.trades);
            });
            
            // æŠ•èµ„ç»„åˆå†å²æ•°æ®æ›´æ–°
            socket.on('portfolio_history_update', function(data) {
                console.log('æ”¶åˆ°æŠ•èµ„ç»„åˆå†å²æ•°æ®æ›´æ–°', data);
                updatePortfolioChart(data);
            });
            
            // æŠ•èµ„ç»„åˆå†å²æ•°æ®é”™è¯¯
            socket.on('portfolio_history_error', function(data) {
                console.error('æŠ•èµ„ç»„åˆå†å²æ•°æ®é”™è¯¯:', data.error);
                // å¯ä»¥åœ¨è¿™é‡Œæ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
            });
            
            // åŸºç¡€åˆ†ææ•°æ®æ›´æ–°
            socket.on('basic_analysis_update', function(data) {
                console.log('æ”¶åˆ°åŸºç¡€åˆ†ææ•°æ®æ›´æ–°', data);
                updateBasicAnalysis(data.analysis);
            });
            
            // åŸºç¡€åˆ†æé”™è¯¯
            socket.on('basic_analysis_error', function(data) {
                console.error('åŸºç¡€åˆ†æé”™è¯¯:', data.error);
                document.getElementById('smartAnalysis').innerHTML = 
                    `<div class="error">è·å–åŸºç¡€åˆ†æå¤±è´¥: ${data.error}</div>`;
            });
            
            // æ™ºèƒ½åˆ†æä»»åŠ¡å¯åŠ¨
            socket.on('smart_analysis_started', function(data) {
                console.log('æ™ºèƒ½åˆ†æä»»åŠ¡å·²å¯åŠ¨:', data);
                currentAnalysisTaskId = data.task_id;
                
                // æ˜¾ç¤ºåˆ†æè¿›åº¦ç•Œé¢
                const container = document.getElementById('smartAnalysis');
                
                // åˆ›å»ºAIåˆ†æè¿›åº¦å…ƒç´ 
                const aiAnalysisDiv = document.createElement('div');
                aiAnalysisDiv.id = 'aiAnalysisProgress';
                aiAnalysisDiv.innerHTML = `
                    <div class="analysis-loading" style="margin-bottom: 20px;">
                        <div class="loading-spinner"></div>
                        <h3>ğŸ¤– OpenAI AIåˆ†æè¿›è¡Œä¸­...</h3>
                        <p>æ­£åœ¨ä¸ºæ‚¨æä¾›æ›´æ·±å…¥çš„æ™ºèƒ½åˆ†æ...</p>
                        <div class="progress-bar">
                            <div class="progress-fill" id="analysisProgress" style="width: 10%;"></div>
                        </div>
                        <div class="progress-text" id="progressText">å‡†å¤‡ä¸­...</div>
                        <button class="cancel-btn" onclick="cancelAnalysis()">å–æ¶ˆAIåˆ†æ</button>
                    </div>
                `;
                
                // å°†AIåˆ†æè¿›åº¦æ’å…¥åˆ°åŸºç¡€åˆ†æçš„é¡¶éƒ¨
                const basicAnalysisContainer = container.querySelector('.basic-analysis-container');
                if (basicAnalysisContainer) {
                    // å¦‚æœæœ‰åŸºç¡€åˆ†æï¼Œæ’å…¥åˆ°åŸºç¡€åˆ†æä¹‹å‰
                    container.insertBefore(aiAnalysisDiv, basicAnalysisContainer);
                } else {
                    // å¦‚æœæ²¡æœ‰åŸºç¡€åˆ†æï¼Œç›´æ¥æ·»åŠ åˆ°å®¹å™¨ä¸­
                    container.appendChild(aiAnalysisDiv);
                }
                
                // å¼€å§‹è½®è¯¢çŠ¶æ€
                startWebSocketPolling(data.task_id);
            });
            
            // æ™ºèƒ½åˆ†æé”™è¯¯
            socket.on('smart_analysis_error', function(data) {
                console.error('æ™ºèƒ½åˆ†æé”™è¯¯:', data.error);
                document.getElementById('smartAnalysis').innerHTML = 
                    `<div class="error">å¯åŠ¨æ™ºèƒ½åˆ†æå¤±è´¥: ${data.error}</div>`;
            });
            
            // åˆ†æçŠ¶æ€æ›´æ–°
            socket.on('analysis_status_update', function(data) {
                console.log('åˆ†æçŠ¶æ€æ›´æ–°:', data);
                handleAnalysisStatusUpdate(data);
            });
            
            // åˆ†æçŠ¶æ€é”™è¯¯
            socket.on('analysis_status_error', function(data) {
                console.error('åˆ†æçŠ¶æ€é”™è¯¯:', data.error);
                currentAnalysisTaskId = null;
            });
            
            // è¿æ¥é”™è¯¯å¤„ç†
            socket.on('connect_error', function(error) {
                console.error('WebSocketè¿æ¥é”™è¯¯:', error);
                updateStatus('offline');
            });
            
            // å¿«ç…§ä¿å­˜æˆåŠŸ
            socket.on('snapshot_save_success', function(data) {
                console.log('å¿«ç…§ä¿å­˜æˆåŠŸ:', data);
                alert('âœ… å¿«ç…§ä¿å­˜æˆåŠŸï¼');
            });
            
            // å¿«ç…§ä¿å­˜å¤±è´¥
            socket.on('snapshot_save_error', function(data) {
                console.error('å¿«ç…§ä¿å­˜å¤±è´¥:', data.error);
                alert('âŒ ä¿å­˜å¤±è´¥: ' + data.error);
            });
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // åˆå§‹åŒ–WebSocketè¿æ¥
            initWebSocket();
            
            // æŠ•èµ„ç»„åˆå›¾è¡¨å°†åœ¨æ¥æ”¶åˆ°å†å²æ•°æ®åè‡ªåŠ¨æ›´æ–°
            // WebSocket 'all' è¯·æ±‚å·²ç»åŒ…å«å†å²æ•°æ®ï¼Œæ— éœ€é¢å¤–è¯·æ±‚
            
            // æ™ºèƒ½åˆ†æå°†åœ¨WebSocketè¿æ¥æˆåŠŸåè‡ªåŠ¨å¯åŠ¨
            
            // é¡µé¢å¯è§æ€§æ£€æµ‹
            document.addEventListener('visibilitychange', function() {
                if (document.hidden) {
                    // é¡µé¢éšè—æ—¶å¯ä»¥æš‚åœæŸäº›æ›´æ–°
                    console.log('é¡µé¢éšè—ï¼Œå‡å°‘WebSocketæ´»åŠ¨');
                } else {
                    // é¡µé¢å¯è§æ—¶æ¢å¤æ›´æ–°
                    console.log('é¡µé¢å¯è§ï¼Œæ¢å¤WebSocketæ´»åŠ¨');
                    if (socket && socket.connected) {
                        // é˜²æŠ–ï¼šé™åˆ¶è¯·æ±‚é¢‘ç‡ï¼Œé¿å…é¢‘ç¹åˆ‡æ¢é¡µé¢æ—¶çš„é‡å¤è¯·æ±‚
                        const now = Date.now();
                        if (now - lastDataRequestTime > 5000) { // 5ç§’å†…ä¸é‡å¤è¯·æ±‚
                            console.log('é¡µé¢é‡æ–°å¯è§ï¼Œåˆ·æ–°æ•°æ®');
                            socket.emit('request_data', {type: 'all'});
                            lastDataRequestTime = now;
                        } else {
                            console.log('è¯·æ±‚é¢‘ç‡é™åˆ¶ï¼Œè·³è¿‡æ­¤æ¬¡åˆ·æ–°');
                        }
                    }
                }
            });
            
            // æ¯5åˆ†é’Ÿè‡ªåŠ¨åˆ·æ–°æ™ºèƒ½åˆ†æï¼ˆä»…åœ¨é¡µé¢å¯è§æ—¶ï¼‰
            setInterval(() => {
                if (document.hidden) return; // é¡µé¢ä¸å¯è§æ—¶ä¸åˆ·æ–°
                loadSmartAnalysis(false); // å®šæ—¶åˆ·æ–°ä¸ä½¿ç”¨å¼ºåˆ¶åˆ·æ–°
            }, 300000); // 5åˆ†é’Ÿ
        });

        // ä¿å­˜æŠ•èµ„ç»„åˆå¿«ç…§
        function saveSnapshot() {
            try {
                if (socket && socket.connected) {
                    // ä½¿ç”¨WebSocketå‘é€ä¿å­˜å¿«ç…§è¯·æ±‚
                    socket.emit('save_snapshot', {});
                } else {
                    // WebSocketæœªè¿æ¥æ—¶çš„å¤‡ç”¨æ–¹æ¡ˆ
                    console.warn('WebSocketæœªè¿æ¥ï¼Œä½¿ç”¨HTTP APIå¤‡ç”¨æ–¹æ¡ˆ');
                    // saveSnapshotHTTP();
                }
            } catch (error) {
                console.error('ä¿å­˜å¿«ç…§å¤±è´¥:', error);
                alert('âŒ ä¿å­˜å¤±è´¥: ' + error.message);
            }
        }
        
        
        // åˆ·æ–°æ‰€æœ‰æ•°æ®
        function refreshAllData() {
            if (socket && socket.connected) {
                updateStatus('connecting');
                socket.emit('request_data', {type: 'all'});
                lastDataRequestTime = Date.now(); // è®°å½•è¯·æ±‚æ—¶é—´
            } else {
                // å¦‚æœWebSocketæœªè¿æ¥ï¼Œå°è¯•é‡æ–°è¿æ¥
                console.log('WebSocketæœªè¿æ¥ï¼Œå°è¯•é‡æ–°è¿æ¥...');
                if (socket) {
                    socket.disconnect();
                }
                initWebSocket();
            }
        }
        
        // æ‰‹åŠ¨è¯·æ±‚ç‰¹å®šæ•°æ®
        function requestDataUpdate(dataType) {
            if (socket && socket.connected) {
                socket.emit('request_data', {type: dataType});
            }
        }
        
        // WebSocketé‡è¿åŠŸèƒ½
        function toggleWebSocket() {
            const btn = document.getElementById('wsToggleBtn');
            
            if (socket && socket.connected) {
                // æ–­å¼€è¿æ¥
                socket.disconnect();
                btn.textContent = 'é‡è¿WebSocket';
                updateStatus('offline');
            } else {
                // é‡æ–°è¿æ¥
                btn.textContent = 'è¿æ¥ä¸­...';
                btn.disabled = true;
                
                if (socket) {
                    socket.disconnect();
                }
                
                setTimeout(() => {
                    initWebSocket();
                    btn.disabled = false;
                    btn.textContent = socket && socket.connected ? 'æ–­å¼€WebSocket' : 'é‡è¿WebSocket';
                }, 1000);
            }
        }

        // æ›´æ–°è¿æ¥çŠ¶æ€
        function updateStatus(status) {
            const indicator = document.getElementById('statusIndicator');
            const text = document.getElementById('statusText');
            const wsStatus = document.getElementById('wsStatus');
            const wsToggleBtn = document.getElementById('wsToggleBtn');
            
            if (status === 'online') {
                indicator.className = 'status-indicator status-online';
                text.textContent = 'å·²è¿æ¥';
                if (socket && socket.connected) {
                    const transport = socket.io.engine ? socket.io.engine.transport.name : 'unknown';
                    wsStatus.textContent = `WebSocket`;
                    wsStatus.style.color = '#28a745';
                    wsToggleBtn.textContent = 'æ–­å¼€WS';
                } else {
                    wsStatus.textContent = 'HTTP API';
                    wsStatus.style.color = '#ffc107';
                    wsToggleBtn.textContent = 'è¿æ¥WS';
                }
            } else if (status === 'offline') {
                indicator.className = 'status-indicator status-offline';
                text.textContent = 'è¿æ¥å¤±è´¥';
                wsStatus.textContent = 'ç¦»çº¿';
                wsStatus.style.color = '#dc3545';
                wsToggleBtn.textContent = 'é‡è¿WS';
            } else if (status === 'connecting') {
                indicator.className = 'status-indicator';
                text.textContent = 'è¿æ¥ä¸­...';
                wsStatus.textContent = 'æ­£åœ¨è¿æ¥...';
                wsStatus.style.color = '#6c757d';
                wsToggleBtn.textContent = 'è¿æ¥ä¸­...';
            }
        }

        // åŠ è½½æŠ•èµ„ç»„åˆå†å²æ•°æ®ï¼ˆç”¨äºå›¾è¡¨ï¼‰
        function loadPortfolioHistory() {
            try {
                if (socket && socket.connected) {
                    // é€šè¿‡WebSocketè¯·æ±‚å†å²æ•°æ®
                    socket.emit('request_data', { type: 'portfolio_history' });
                } else {
                    // WebSocketæœªè¿æ¥æ—¶ä½¿ç”¨HTTP APIä½œä¸ºå¤‡ç”¨
                    // loadPortfolioHistoryHTTP();
                }
            } catch (error) {
                console.error('è¯·æ±‚æŠ•èµ„ç»„åˆå†å²æ•°æ®å¤±è´¥:', error);
                // å¤‡ç”¨æ–¹æ¡ˆ
                // loadPortfolioHistoryHTTP();
            }
        }

      

        // æ›´æ–°æŠ•èµ„ç»„åˆæ¦‚è§ˆ
        function updatePortfolioOverview(data) {
            const container = document.getElementById('portfolioOverview');
            
            container.innerHTML = `
                <div class="metric">
                    <span class="metric-label">æ€»ä»·å€¼</span>
                    <span class="metric-value">$${data.total_value?.toFixed(2) || '0.00'}</span>
                </div>
                <div class="metric">
                    <span class="metric-label">æ€»æˆæœ¬</span>
                    <span class="metric-value">$${data.total_cost?.toFixed(2) || '0.00'}</span>
                </div>
                <div class="metric">
                    <span class="metric-label">æœªå®ç°ç›ˆäº</span>
                    <span class="metric-value ${data.total_pnl >= 0 ? 'positive' : 'negative'}">
                        $${data.total_pnl?.toFixed(2) || '0.00'} (${(data.total_pnl_rate * 100)?.toFixed(2) || '0.00'}%)
                    </span>
                </div>
                <div class="metric">
                    <span class="metric-label">æ€»æ”¶ç›Šç‡</span>
                    <span class="metric-value ${data.performance?.total_return >= 0 ? 'positive' : 'negative'}">
                        ${(data.performance?.total_return * 100)?.toFixed(2) || '0.00'}%
                    </span>
                </div>
            `;
        }

        // æ›´æ–°æŒä»“ä¿¡æ¯
        function updatePositions(positions) {
            const container = document.getElementById('positions');
            
            if (!positions || positions.length === 0) {
                container.innerHTML = '<div class="loading">æš‚æ— æŒä»“</div>';
                return;
            }
            
            let html = '<div class="table-container"><table class="table"><tr><th>å¸ç§</th><th>æ•°é‡</th><th>å‡ä»·</th><th>å¸‚å€¼</th><th>ç›ˆäº</th><th>ç›ˆåˆ©ç‡</th></tr>';
            
            positions.forEach(pos => {
                // æ ¼å¼åŒ–ç›ˆåˆ©ç‡
                const pnlRate = pos.unrealized_pnl_rate || 0;
                const pnlRateDisplay = `${(pnlRate * 100).toFixed(2)}%`;
                
                html += `
                    <tr>
                        <td>${pos.currency}</td>
                        <td>${pos.amount?.toFixed(4) || '0'}</td>
                        <td>$${pos.avg_price?.toFixed(2) || '0.00'}</td>
                        <td>$${pos.market_value?.toFixed(2) || '0.00'}</td>
                        <td class="${pos.unrealized_pnl >= 0 ? 'positive' : 'negative'}">
                            $${pos.unrealized_pnl?.toFixed(2) || '0.00'}
                        </td>
                        <td class="${pnlRate >= 0 ? 'positive' : 'negative'}">
                            ${pnlRateDisplay}
                        </td>
                    </tr>
                `;
            });
            
            html += '</table></div>';
            container.innerHTML = html;
        }

      

        // æ›´æ–°å¸‚åœºæ•°æ®
        function updateMarketData(marketData) {
            const container = document.getElementById('marketData');
            
            if (!marketData || Object.keys(marketData).length === 0) {
                container.innerHTML = '<div class="loading">æš‚æ— æ•°æ®</div>';
                return;
            }
            
            let html = '<div class="table-container"><table class="table"><tr><th>äº¤æ˜“å¯¹</th><th>ä»·æ ¼</th><th>24hå˜åŒ–</th></tr>';
            
            Object.entries(marketData).forEach(([symbol, data]) => {
                html += `
                    <tr>
                        <td>${symbol}</td>
                        <td>$${data.price?.toFixed(2) || '0.00'}</td>
                        <td class="${data.percentage >= 0 ? 'positive' : 'negative'}">
                            ${data.percentage?.toFixed(2) || '0.00'}%
                        </td>
                    </tr>
                `;
            });
            
            html += '</table></div>';
            container.innerHTML = html;
        }

        // åŠ è½½æ™ºèƒ½åˆ†æï¼ˆWebSocketç‰ˆæœ¬ï¼‰
        async function loadSmartAnalysis(forceRefresh = false) {
            try {
                // å¦‚æœå·²æœ‰æ­£åœ¨è¿›è¡Œçš„ä»»åŠ¡ï¼Œå…ˆæ¸…ç†
                if (currentAnalysisTaskId) {
                    currentAnalysisTaskId = null;
                }
                
                // ä¿å­˜å¼ºåˆ¶åˆ·æ–°çŠ¶æ€ï¼Œä¾›åç»­ä½¿ç”¨
                pendingForceRefresh = forceRefresh;
                
                // æ£€æŸ¥æ˜¯å¦å·²æœ‰åŸºç¡€åˆ†æï¼Œå¦‚æœæ²¡æœ‰åˆ™å…ˆè¯·æ±‚åŸºç¡€åˆ†æ
                const basicAnalysisContainer = document.querySelector('.basic-analysis-container');
                if (!basicAnalysisContainer && socket && socket.connected) {
                    socket.emit('request_data', { type: 'basic_analysis' });
                    // ç­‰å¾…åŸºç¡€åˆ†æå®Œæˆåå†å¯åŠ¨AIåˆ†æï¼ˆé€šè¿‡updateBasicAnalysiså‡½æ•°å¤„ç†ï¼‰
                    return;
                }
                
                // å¦‚æœå·²æœ‰åŸºç¡€åˆ†æï¼Œç›´æ¥å¯åŠ¨AIåˆ†æ
                if (socket && socket.connected) {
                    // socket.emit('request_smart_analysis', { force_refresh: forceRefresh });
                    // æ¸…é™¤pendingçŠ¶æ€
                    pendingForceRefresh = false;
                } else {
                    console.warn('WebSocketæœªè¿æ¥ï¼Œæ— æ³•å¯åŠ¨æ™ºèƒ½åˆ†æã€‚');
                }
                
            } catch (error) {
                console.error('å¯åŠ¨æ™ºèƒ½åˆ†æå¤±è´¥:', error);
            }
        }
        
     
        // WebSocketæ™ºèƒ½è½®è¯¢ - ç”¨äºåˆ†æçŠ¶æ€
        function startWebSocketPolling(taskId) {
            let pollCount = 0;
            const maxPolls = 150; // æœ€å¤šè½®è¯¢150æ¬¡ï¼ˆå¤§çº¦10åˆ†é’Ÿï¼‰
            
            function poll() {
                pollCount++;
                
                // å‰30ç§’æ¯2ç§’æ£€æŸ¥ä¸€æ¬¡ï¼Œä¹‹åæ¯5ç§’æ£€æŸ¥ä¸€æ¬¡
                const interval = pollCount < 15 ? 2000 : 5000;
                
                if (socket && socket.connected && currentAnalysisTaskId === taskId) {
                    // é€šè¿‡WebSocketè¯·æ±‚çŠ¶æ€æ›´æ–°
                    socket.emit('request_analysis_status', { task_id: taskId });
                    
                    // å¦‚æœä»»åŠ¡è¿˜åœ¨è¿›è¡Œä¸”æœªè¶…è¿‡æœ€å¤§è½®è¯¢æ¬¡æ•°
                    if (pollCount < maxPolls) {
                        setTimeout(poll, interval);
                    } else {
                        // è¶…è¿‡æœ€å¤§è½®è¯¢æ¬¡æ•°
                        currentAnalysisTaskId = null;
                        document.getElementById('smartAnalysis').innerHTML = 
                            `<div class="error">
                                <h3>â° è½®è¯¢è¶…æ—¶</h3>
                                <p>åˆ†æä»»åŠ¡å¯èƒ½éœ€è¦æ›´é•¿æ—¶é—´ï¼Œè¯·ç¨åæ‰‹åŠ¨åˆ·æ–°</p>
                                <button onclick="loadSmartAnalysis(true)" class="retry-btn">é‡æ–°åˆ†æ</button>
                            </div>`;
                    }
                } else {
                    // WebSocketæ–­å¼€æˆ–ä»»åŠ¡IDå˜åŒ–ï¼Œåœæ­¢è½®è¯¢
                    currentAnalysisTaskId = null;
                }
            }
            
            // ç«‹å³å¼€å§‹ç¬¬ä¸€æ¬¡æ£€æŸ¥
            setTimeout(poll, 1000); // 1ç§’åå¼€å§‹è½®è¯¢
        }
        
        // å¤„ç†åˆ†æçŠ¶æ€æ›´æ–°
        function handleAnalysisStatusUpdate(statusData) {
            const progress = Math.round(statusData.progress * 100);
            const progressBar = document.getElementById('analysisProgress');
            const progressText = document.getElementById('progressText');
            
            if (progressBar) {
                progressBar.style.width = `${progress}%`;
            }
            
            // æ›´æ–°çŠ¶æ€æ–‡æœ¬
            let statusText = '';
            switch (statusData.status) {
                case 'pending':
                    statusText = 'ç­‰å¾…å¤„ç†...';
                    break;
                case 'running':
                    if (progress < 30) {
                        statusText = 'è·å–å¸‚åœºæ•°æ®...';
                    } else if (progress < 60) {
                        statusText = 'OpenAI AI åˆ†æä¸­...';
                    } else if (progress < 90) {
                        statusText = 'ç”ŸæˆæŠ•èµ„å»ºè®®...';
                    } else {
                        statusText = 'å®Œæˆåˆ†æ...';
                    }
                    break;
                case 'completed':
                    statusText = 'åˆ†æå®Œæˆï¼';
                    currentAnalysisTaskId = null; // æ¸…é™¤å½“å‰ä»»åŠ¡ID
                    
                    // ç§»é™¤AIåˆ†æè¿›åº¦æ˜¾ç¤º
                    const progressDiv = document.getElementById('aiAnalysisProgress');
                    if (progressDiv) {
                        progressDiv.remove();
                    }
                    
                    // ç”¨AIåˆ†æç»“æœæ›¿æ¢æˆ–æ›´æ–°ç°æœ‰å†…å®¹
                    updateSmartAnalysis(statusData.result);
                    return; // ä¸å†ç»§ç»­è½®è¯¢
                case 'failed':
                    statusText = `åˆ†æå¤±è´¥: ${statusData.error}`;
                    currentAnalysisTaskId = null; // æ¸…é™¤å½“å‰ä»»åŠ¡ID
                    document.getElementById('smartAnalysis').innerHTML = 
                        `<div class="error">
                            <h3>âŒ åˆ†æå¤±è´¥</h3>
                            <p>${statusData.error}</p>
                            <button onclick="loadSmartAnalysis(true)" class="retry-btn">é‡æ–°åˆ†æ</button>
                        </div>`;
                    return; // ä¸å†ç»§ç»­è½®è¯¢
                case 'timeout':
                    statusText = 'åˆ†æè¶…æ—¶';
                    currentAnalysisTaskId = null; // æ¸…é™¤å½“å‰ä»»åŠ¡ID
                    document.getElementById('smartAnalysis').innerHTML = 
                        `<div class="error">
                            <h3>â° åˆ†æè¶…æ—¶</h3>
                            <p>OpenAI APIå“åº”è¶…æ—¶ï¼Œè¯·ç¨åé‡è¯•</p>
                            <button onclick="loadSmartAnalysis(true)" class="retry-btn">é‡æ–°åˆ†æ</button>
                        </div>`;
                    return; // ä¸å†ç»§ç»­è½®è¯¢
            }
            
            if (progressText) {
                progressText.textContent = `${statusText} (${progress}%)`;
            }
        }


        // å–æ¶ˆåˆ†æ
        function cancelAnalysis() {
            if (currentAnalysisTaskId) {
                currentAnalysisTaskId = null;
            }
            currentAnalysisTaskId = null;
            
            document.getElementById('smartAnalysis').innerHTML = 
                `<div class="cancelled">
                    <h3>ğŸ›‘ åˆ†æå·²å–æ¶ˆ</h3>
                    <p>æ‚¨å¯ä»¥éšæ—¶é‡æ–°å¼€å§‹åˆ†æ</p>
                    <button onclick="loadSmartAnalysis(true)" class="retry-btn">å¼€å§‹åˆ†æ</button>
                </div>`;
        }

        // æ›´æ–°åŸºç¡€åˆ†ææ˜¾ç¤º
        function updateBasicAnalysis(analysisData) {
            const container = document.getElementById('smartAnalysis');
            
            if (!analysisData) {
                // åªæœ‰åœ¨æ²¡æœ‰AIåˆ†æè¿›åº¦æ—¶æ‰æ˜¾ç¤º"æš‚æ— åˆ†ææ•°æ®"
                const aiProgress = document.getElementById('aiAnalysisProgress');
                if (!aiProgress) {
                    container.innerHTML = '<div class="loading">æš‚æ— åˆ†ææ•°æ®</div>';
                }
                return;
            }
            
            // æ£€æŸ¥æ˜¯å¦å·²æœ‰AIåˆ†æè¿›åº¦åœ¨æ˜¾ç¤º
            const existingProgress = document.getElementById('aiAnalysisProgress');
            
            let html = `
                <div class="basic-analysis-container">
                    <div style="background: #e8f4fd; padding: 10px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #007bff;">
                        <h4 style="color: #007bff; margin: 0;">ğŸ“Š å¿«é€ŸæŠ•èµ„ç»„åˆåˆ†æ</h4>
                        <p style="margin: 5px 0 0 0; color: #666; font-size: 0.9em;">åŸºäºå½“å‰æ•°æ®çš„å³æ—¶åˆ†æï¼ŒAIæ·±åº¦åˆ†æå³å°†å¯åŠ¨...</p>
                    </div>

                    <!-- æŠ•èµ„ç»„åˆæ¦‚è§ˆ -->
                    <div class="analysis-section" style="margin-bottom: 20px;">
                        <h4 style="color: #2c3e50; margin-bottom: 10px;">ğŸ’¼ æŠ•èµ„ç»„åˆæ¦‚è§ˆ</h4>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #28a745;">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                                <div>
                                    <strong>æ€»ä»·å€¼:</strong> $${analysisData.portfolio_overview.total_value.toFixed(2)} USDT<br>
                                    <strong>æ€»æˆæœ¬:</strong> $${analysisData.portfolio_overview.total_cost.toFixed(2)} USDT<br>
                                    <strong>ç›ˆäº:</strong> <span style="color: ${analysisData.portfolio_overview.total_pnl >= 0 ? '#28a745' : '#dc3545'}">
                                        $${analysisData.portfolio_overview.total_pnl.toFixed(2)} (${(analysisData.portfolio_overview.total_pnl_rate * 100).toFixed(2)}%)
                                    </span>
                                </div>
                                <div>
                                    <strong>æŒä»“æ•°é‡:</strong> ${analysisData.portfolio_overview.total_positions}<br>
                                    <strong>ç›ˆåˆ©æŒä»“:</strong> ${analysisData.portfolio_overview.profitable_positions}<br>
                                    <strong>äºæŸæŒä»“:</strong> ${analysisData.portfolio_overview.loss_positions}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- èµ„äº§é…ç½® -->
                    <div class="analysis-section" style="margin-bottom: 20px;">
                        <h4 style="color: #2c3e50; margin-bottom: 10px;">ğŸ¯ èµ„äº§é…ç½®</h4>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #007bff;">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
                                ${Object.entries(analysisData.asset_allocation).map(([asset, percentage]) => `
                                    <div style="text-align: center; padding: 10px; background: white; border-radius: 5px;">
                                        <strong>${asset}</strong><br>
                                        <span style="font-size: 1.2em; color: #007bff;">${percentage.toFixed(1)}%</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>

                    <!-- é£é™©è¯„ä¼° -->
                    <div class="analysis-section" style="margin-bottom: 20px;">
                        <h4 style="color: #2c3e50; margin-bottom: 10px;">âš ï¸ é£é™©è¯„ä¼°</h4>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #ffc107;">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                                <div>
                                    <strong>é£é™©ç­‰çº§:</strong> 
                                    <span style="padding: 3px 8px; border-radius: 4px; background: ${getRiskColor(analysisData.risk_assessment.risk_level)}; color: white;">
                                        ${analysisData.risk_assessment.risk_level}
                                    </span>
                                </div>
                                <div>
                                    <strong>å¤šæ ·åŒ–åˆ†æ•°:</strong> ${(analysisData.risk_assessment.diversification_score * 100).toFixed(1)}%<br>
                                    <div style="width: 100%; height: 8px; background: #e0e0e0; border-radius: 4px; margin-top: 5px;">
                                        <div style="width: ${analysisData.risk_assessment.diversification_score * 100}%; height: 100%; background: #28a745; border-radius: 4px;"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- åŸºç¡€å»ºè®® -->
                    ${analysisData.basic_suggestions && analysisData.basic_suggestions.length > 0 ? `
                    <div class="analysis-section" style="margin-bottom: 20px;">
                        <h4 style="color: #2c3e50; margin-bottom: 10px;">ğŸ’¡ åŸºç¡€å»ºè®®</h4>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #17a2b8;">
                            ${analysisData.basic_suggestions.map(suggestion => `
                                <div style="margin-bottom: 10px; padding: 10px; background: white; border-radius: 5px; border-left: 3px solid #17a2b8;">
                                    ${suggestion}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    ` : ''}

                    <!-- åˆ†ææ—¶é—´æˆ³ -->
                    <div style="text-align: center; margin-top: 20px; color: #666; font-size: 0.9em;">
                        åŸºç¡€åˆ†ææ—¶é—´: ${new Date(analysisData.analysis_timestamp).toLocaleString('zh-CN')}
                    </div>
                </div>
            `;
            
            if (existingProgress) {
                // å¦‚æœå·²æœ‰AIåˆ†æè¿›åº¦ï¼Œå°†åŸºç¡€åˆ†ææ’å…¥åˆ°è¿›åº¦åé¢
                existingProgress.insertAdjacentHTML('afterend', html);
            } else {
                // å¦‚æœæ²¡æœ‰AIåˆ†æè¿›åº¦ï¼Œç›´æ¥æ›¿æ¢æ•´ä¸ªå®¹å™¨å†…å®¹
                container.innerHTML = html;
                
                // åŸºç¡€åˆ†ææ˜¾ç¤ºå®Œæˆåï¼Œå¯åŠ¨AIåˆ†æ
                setTimeout(() => {
                    startSmartAnalysisAfterBasic();
                }, 500);
            }
        }
        
        // åŸºç¡€åˆ†æå®Œæˆåå¯åŠ¨AIåˆ†æ
        function startSmartAnalysisAfterBasic() {
            // æ£€æŸ¥WebSocketè¿æ¥çŠ¶æ€
            if (socket && socket.connected) {
                // ä½¿ç”¨ä¿å­˜çš„å¼ºåˆ¶åˆ·æ–°çŠ¶æ€å¯åŠ¨AIåˆ†æ
                socket.emit('request_smart_analysis', { force_refresh: pendingForceRefresh });
                // æ¸…é™¤pendingçŠ¶æ€
                pendingForceRefresh = false;
            } else {
                console.warn('WebSocketæœªè¿æ¥ï¼Œæ— æ³•å¯åŠ¨AIåˆ†æ');
            }
        }

        // è·å–é£é™©ç­‰çº§é¢œè‰²
        function getRiskColor(riskLevel) {
            switch(riskLevel) {
                case 'ä½é£é™©': return '#28a745';
                case 'ä¸­ç­‰é£é™©': return '#ffc107';
                case 'ä¸­é«˜é£é™©': return '#fd7e14';
                case 'é«˜é£é™©': return '#dc3545';
                default: return '#6c757d';
            }
        }

        // åŠ è½½æ™ºèƒ½åˆ†æï¼ˆåŒæ­¥ç‰ˆæœ¬ï¼Œç”¨äºå¿«é€ŸæŸ¥çœ‹ï¼‰
       
        // æ›´æ–°æ™ºèƒ½åˆ†ææ˜¾ç¤ºï¼ˆç®€åŒ–ç‰ˆæœ¬ï¼Œåç«¯å·²å¤„ç†æ ¼å¼åŒ–ï¼‰
        // é‡æ–°è®¾è®¡çš„Markdownè½¬HTMLå‡½æ•° - å¤„ç†å¤æ‚ç»“æ„
        function markdownToHtml(markdown) {
            if (!markdown) return '';
            
            // æ¸…ç†è¾“å…¥å¹¶æŒ‰è¡Œåˆ†å‰²
            let lines = markdown.trim().split('\n');
            let html = '';
            let inList = false;
            
            for (let i = 0; i < lines.length; i++) {
                let line = lines[i];
                let trimmedLine = line.trim();
                
                // è·³è¿‡ç©ºè¡Œ
                if (!trimmedLine) {
                    // å¦‚æœåœ¨åˆ—è¡¨ä¸­é‡åˆ°ç©ºè¡Œï¼Œç»“æŸåˆ—è¡¨
                    if (inList) {
                        html += '</ul>';
                        inList = false;
                    }
                    continue;
                }
                
                // å¤„ç†æ ‡é¢˜
                if (trimmedLine.startsWith('###')) {
                    if (inList) { html += '</ul>'; inList = false; }
                    const title = trimmedLine.replace(/^###\s*/, '');
                    html += `<h5 style="color: #495057; margin: 15px 0 8px 0; font-weight: bold; font-size: 1.05em; border-bottom: 1px solid #e9ecef; padding-bottom: 4px;">${formatInlineText(title)}</h5>`;
                }
                else if (trimmedLine.startsWith('##')) {
                    if (inList) { html += '</ul>'; inList = false; }
                    const title = trimmedLine.replace(/^##\s*/, '');
                    html += `<h4 style="color: #343a40; margin: 18px 0 10px 0; font-weight: bold; font-size: 1.1em; border-bottom: 2px solid #dee2e6; padding-bottom: 6px;">${formatInlineText(title)}</h4>`;
                }
                else if (trimmedLine.startsWith('#')) {
                    if (inList) { html += '</ul>'; inList = false; }
                    const title = trimmedLine.replace(/^#\s*/, '');
                    html += `<h3 style="color: #212529; margin: 20px 0 12px 0; font-weight: bold; font-size: 1.2em; border-bottom: 3px solid #007bff; padding-bottom: 8px;">${formatInlineText(title)}</h3>`;
                }
                // å¤„ç†æ•°å­—æ ‡é¢˜ (å¦‚ "1. **USDTä½™é¢é…ç½®å»ºè®®**ï¼š")
                else if (/^\d+\.\s+/.test(trimmedLine)) {
                    if (inList) { html += '</ul>'; inList = false; }
                    html += `<h5 style="color: #495057; margin: 12px 0 8px 0; font-weight: bold; font-size: 1.05em; background: #f8f9fa; padding: 8px 12px; border-left: 4px solid #007bff; border-radius: 4px;">${formatInlineText(trimmedLine)}</h5>`;
                }
                // å¤„ç†emojiå¼€å¤´çš„ä¸»æ ‡é¢˜
                else if (/^(ğŸ“Š|ğŸ“ˆ|ğŸ¯|ğŸ’¼|âš¡|âš ï¸|ğŸ’¡|ğŸ“‹|ğŸ¤–|ğŸ’°|ğŸ”|ğŸ“Œ|âš–ï¸|ğŸš€|ğŸ›¡ï¸|âœ…|ğŸŸ¡|ğŸŸ¢|ğŸ”½|ğŸ”¼|ğŸ“‰|ğŸ“ˆ|ğŸŸ¢)\s+/.test(trimmedLine)) {
                    if (inList) { html += '</ul>'; inList = false; }
                    html += `<h4 style="color: #2c3e50; margin: 14px 0 8px 0; font-weight: bold; font-size: 1.05em; background: linear-gradient(90deg, #f8f9fa, #ffffff); padding: 10px 15px; border-left: 4px solid #28a745; border-radius: 6px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">${formatInlineText(trimmedLine)}</h4>`;
                }
                // å¤„ç†åˆ—è¡¨é¡¹ï¼ˆåŒ…æ‹¬æœ‰ç¼©è¿›çš„ï¼‰
                else if (trimmedLine.startsWith('- ') || trimmedLine.startsWith('* ') || trimmedLine.startsWith('+ ')) {
                    if (!inList) {
                        html += '<ul style="margin: 8px 0; padding-left: 20px; list-style-type: disc;">';
                        inList = true;
                    }
                    const content = trimmedLine.replace(/^[-*+]\s+/, '');
                    html += `<li style="margin: 4px 0; padding-left: 8px; color: #495057; line-height: 1.5;">${formatInlineText(content)}</li>`;
                }
                // å¤„ç†ç¼©è¿›çš„æ–‡æœ¬ï¼ˆå¯èƒ½æ˜¯å­é¡¹ï¼‰
                else if (line.startsWith('  ') || line.startsWith('\t')) {
                    // å¦‚æœå½“å‰æ²¡æœ‰åœ¨åˆ—è¡¨ä¸­ï¼Œä½†è¿™æ˜¯ç¼©è¿›æ–‡æœ¬ï¼Œä½œä¸ºå­é¡¹å¤„ç†
                    if (!inList) {
                        html += '<ul style="margin: 8px 0; padding-left: 20px; list-style-type: disc;">';
                        inList = true;
                    }
                    html += `<li style="margin: 4px 0; padding-left: 8px; color: #495057; line-height: 1.5;">${formatInlineText(trimmedLine)}</li>`;
                }
                // å¤„ç†æ™®é€šæ®µè½
                else {
                    if (inList) { html += '</ul>'; inList = false; }
                    html += `<p style="margin: 8px 0; line-height: 1.6; color: #495057; font-size: 0.95em;">${formatInlineText(trimmedLine)}</p>`;
                }
            }
            
            // ç¡®ä¿æœ€åå…³é—­åˆ—è¡¨
            if (inList) {
                html += '</ul>';
            }
            
            return html;
        }
        
        // å¤„ç†è¡Œå†…æ ¼å¼ï¼ˆç²—ä½“ã€æ–œä½“ç­‰ï¼‰
        function formatInlineText(text) {
            return text
                // å¤„ç†ç²—ä½“
                .replace(/\*\*(.*?)\*\*/g, '<strong style="color: #2c3e50; font-weight: 600; background: #fff3cd; padding: 2px 4px; border-radius: 3px;">$1</strong>')
                // å¤„ç†æ–œä½“
                .replace(/\*(.*?)\*/g, '<em style="color: #495057; font-style: italic;">$1</em>')
                // å¤„ç†ä»£ç 
                .replace(/`(.*?)`/g, '<code style="background: #f1f3f4; padding: 2px 4px; border-radius: 3px; font-family: monospace;">$1</code>')
                // å¤„ç†ä»·æ ¼ï¼ˆå¦‚ $113,500ï¼‰
                .replace(/\$([0-9,]+(?:\.[0-9]+)?)/g, '<span style="color: #007bff; font-weight: 600;">$$$1</span>')
                // å¤„ç†ç™¾åˆ†æ¯”
                .replace(/([0-9]+(?:\.[0-9]+)?)%/g, '<span style="color: #28a745; font-weight: 600;">$1%</span>');
        }

        function updateSmartAnalysis(analysisData) {
            const container = document.getElementById('smartAnalysis');
            
            if (!analysisData) {
                container.innerHTML = '<div class="loading">æš‚æ— åˆ†ææ•°æ®</div>';
                return;
            }
            
            // æ¸…ç†åŸºç¡€åˆ†æå†…å®¹ï¼Œä¸ºAIåˆ†æç»“æœè®©è·¯
            const basicAnalysisContainer = container.querySelector('.basic-analysis-container');
            if (basicAnalysisContainer) {
                basicAnalysisContainer.remove();
            }
            
            // å¦‚æœæœ‰åŸå§‹AIå“åº”ï¼Œç›´æ¥æ˜¾ç¤º
            if (analysisData.ai_response) {
                let html = `
                    <div class="analysis-container">
                        <!-- AIç½®ä¿¡åº¦æŒ‡ç¤ºå™¨ -->
                        <div class="confidence-indicator" style="margin-bottom: 20px; display: flex; align-items: center; flex-wrap: wrap; width: 100%;">
                            <span style="font-weight: bold; margin-right: 10px; flex-shrink: 0;">AIåˆ†æç½®ä¿¡åº¦:</span>
                            <div class="confidence-bar" style="display: inline-block; width: 100px; height: 20px; background: #f0f0f0; border-radius: 10px; margin: 0 10px; position: relative; flex: 1; max-width: 120px;">
                                <div style="width: ${(analysisData.ai_confidence * 100)}%; height: 100%; background: linear-gradient(90deg, #28a745, #ffc107, #dc3545); border-radius: 10px;"></div>
                            </div>
                            <span style="font-weight: bold; white-space: nowrap; flex-shrink: 0;">${(analysisData.ai_confidence * 100).toFixed(1)}%</span>
                        </div>

                        <!-- åŸå§‹AIåˆ†æå†…å®¹ -->
                        <div class="analysis-section" style="margin-bottom: 20px; width: 100%;">
                            <h4 style="color: #2c3e50; margin-bottom: 10px; word-wrap: break-word;">ğŸ¤– OpenAI AI æŠ•èµ„åˆ†æ</h4>
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #007bff; line-height: 1.6; font-size: 0.95em; word-wrap: break-word; overflow-wrap: break-word; max-width: 100%; overflow-x: hidden; width: 100%; box-sizing: border-box;">
                                ${analysisData.ai_response}
                            </div>
                        </div>

                        <!-- åˆ†ææ—¶é—´æˆ³ -->
                        <div style="text-align: center; margin-top: 20px; color: #666; font-size: 0.9em; word-wrap: break-word;">
                            åˆ†ææ—¶é—´: ${new Date(analysisData.analysis_timestamp).toLocaleString('zh-CN')}
                        </div>
                    </div>
                `;
                container.innerHTML = html;
                return;
            }
            
            // å…¼å®¹æ—§æ ¼å¼ï¼šå¦‚æœæ²¡æœ‰ai_responseä½†æœ‰å…¶ä»–å­—æ®µï¼Œæ˜¾ç¤ºåˆ†æ®µæ ¼å¼
            if (analysisData.market_analysis || analysisData.portfolio_review || analysisData.trading_signals || analysisData.risk_assessment) {
                let html = `
                    <div class="analysis-container">
                        <!-- AIç½®ä¿¡åº¦æŒ‡ç¤ºå™¨ -->
                        <div class="confidence-indicator" style="margin-bottom: 20px; display: flex; align-items: center; flex-wrap: wrap; width: 100%;">
                            <span style="font-weight: bold; margin-right: 10px; flex-shrink: 0;">åˆ†æç½®ä¿¡åº¦:</span>
                            <div class="confidence-bar" style="display: inline-block; width: 100px; height: 20px; background: #f0f0f0; border-radius: 10px; margin: 0 10px; position: relative; flex: 1; max-width: 120px;">
                                <div style="width: ${(analysisData.ai_confidence * 100)}%; height: 100%; background: linear-gradient(90deg, #28a745, #ffc107, #dc3545); border-radius: 10px;"></div>
                            </div>
                            <span style="font-weight: bold; white-space: nowrap; flex-shrink: 0;">${(analysisData.ai_confidence * 100).toFixed(1)}%</span>
                        </div>

                        
                        <!-- é£é™©è¯„ä¼° -->
                        ${analysisData.risk_assessment ? `
                        <div class="analysis-section" style="margin-bottom: 20px; width: 100%;">
                            <h4 style="color: #2c3e50; margin-bottom: 10px; word-wrap: break-word;">ğŸ“Š  å¸‚åœºè¶‹åŠ¿åˆ†æ</h4>
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #dc3545; line-height: 1.6; word-wrap: break-word; overflow-wrap: break-word; max-width: 100%; overflow-x: hidden; width: 100%; box-sizing: border-box;">
                                ${analysisData.risk_assessment}
                            </div>
                        </div>
                        ` : ''}

                        <!-- å¸‚åœºåˆ†æ -->
                        ${analysisData.market_analysis ? `
                        <div class="analysis-section" style="margin-bottom: 20px; width: 100%;">
                            <h4 style="color: #2c3e50; margin-bottom: 10px; word-wrap: break-word;">ğŸ“Š å¸ç§åˆ†æ</h4>
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #007bff; line-height: 1.6; word-wrap: break-word; overflow-wrap: break-word; max-width: 100%; overflow-x: hidden; width: 100%; box-sizing: border-box;">
                                ${analysisData.market_analysis}
                            </div>
                        </div>
                        ` : ''}

                        <!-- åˆ†ææ—¶é—´æˆ³ -->
                        <div style="text-align: center; margin-top: 20px; color: #666; font-size: 0.9em; word-wrap: break-word;">
                            åˆ†ææ—¶é—´: ${new Date(analysisData.analysis_timestamp).toLocaleString('zh-CN')}
                        </div>
                    </div>
                `;
                
                container.innerHTML = html;
                return;
            }
            
            // å¦‚æœæ²¡æœ‰ä»»ä½•æœ‰æ•ˆæ•°æ®
            container.innerHTML = '<div class="loading">æš‚æ— åˆ†ææ•°æ®</div>';
        }

        // è·å–æ“ä½œé¢œè‰²
        function getActionColor(action) {
            switch(action) {
                case 'BUY': return '#28a745';
                case 'SELL': return '#dc3545';
                case 'HOLD': return '#ffc107';
                default: return '#6c757d';
            }
        }

        // è·å–æ“ä½œæ–‡æœ¬
        function getActionText(action) {
            switch(action) {
                case 'BUY': return 'ä¹°å…¥';
                case 'SELL': return 'å–å‡º';
                case 'HOLD': return 'æŒæœ‰';
                default: return action;
            }
        }

        // ä¿æŒå‘åå…¼å®¹çš„AIå»ºè®®åŠ è½½å‡½æ•°
        async function loadRecommendations() {
            return loadSmartAnalysis(false); // å»ºè®®åŠ è½½ä¸ä½¿ç”¨å¼ºåˆ¶åˆ·æ–°
        }

     
        // æ›´æ–°æœªå®Œæˆè®¢å•
        function updateOpenOrders(orders) {
            const container = document.getElementById('openOrders');
            
            if (!orders || orders.length === 0) {
                container.innerHTML = '<div class="loading">æš‚æ— æœªå®Œæˆè®¢å•</div>';
                return;
            }
            
            let html = '<div class="table-container"><table class="table"><tr><th>äº¤æ˜“å¯¹</th><th>ç±»å‹</th><th>æ•°é‡</th><th>ä»·æ ¼</th><th>é‡‘é¢</th><th>çŠ¶æ€</th></tr>';
            
            orders.forEach(order => {
                const sideClass = order.side === 'buy' ? 'positive' : 'negative';
                const sideText = order.side === 'buy' ? 'ä¹°å…¥' : 'å–å‡º';
                
                // ç¡®å®šè®¢å•ç±»å‹æ˜¾ç¤ºæ–‡æœ¬
                let typeText = 'é™ä»·';
                let statusText = 'ç­‰å¾…æˆäº¤';
                let statusColor = '#007bff';
                
                const orderType = order.type?.toLowerCase() || '';
                
                if (orderType === 'market') {
                    typeText = 'å¸‚ä»·';
                } else if (orderType.includes('stop')) {
                    typeText = order.side === 'buy' ? 'æ­¢æŸä¹°å…¥' : 'æ­¢æŸå–å‡º';
                    statusText = 'å¾…è§¦å‘';
                    statusColor = '#ffc107';
                } else if (orderType.includes('take_profit')) {
                    typeText = 'æ­¢ç›ˆ';
                    statusText = 'å¾…è§¦å‘';
                    statusColor = '#ffc107';
                } else if (orderType.includes('oco')) {
                    typeText = 'OCOè®¢å•';
                    statusText = 'å¾…è§¦å‘';
                    statusColor = '#ffc107';
                } else if (orderType.includes('trigger')) {
                    typeText = 'è§¦å‘è®¢å•';
                    statusText = 'å¾…è§¦å‘';
                    statusColor = '#ffc107';
                } else if (orderType.includes('conditional')) {
                    typeText = 'æ¡ä»¶è®¢å•';
                    statusText = 'å¾…è§¦å‘';
                    statusColor = '#ffc107';
                }
                
                // æ™ºèƒ½æ ¼å¼åŒ–æ•°é‡æ˜¾ç¤º
                function formatAmount(amount, symbol) {
                    const amt = parseFloat(amount);
                    
                    // æ ¹æ®å¸ç§å’Œæ•°é‡å¤§å°å†³å®šç²¾åº¦
                    if (symbol.includes('BTC')) {
                        return amt.toFixed(6); // BTCä¿ç•™6ä½å°æ•°
                    } else if (symbol.includes('ETH')) {
                        return amt.toFixed(4); // ETHä¿ç•™4ä½å°æ•°
                    } else if (symbol.includes('ADA')) {
                        return amt.toFixed(0); // ADAç­‰å°ä»·å€¼å¸ç§ä¿ç•™æ•´æ•°
                    } else if (amt < 1) {
                        return amt.toFixed(6); // å°äº1çš„æ•°é‡ä¿ç•™6ä½
                    } else if (amt < 100) {
                        return amt.toFixed(3); // 1-100ä¿ç•™3ä½
                    } else {
                        return amt.toFixed(0); // å¤§äº100ä¿ç•™æ•´æ•°
                    }
                }
                
                // æ™ºèƒ½æ ¼å¼åŒ–ä»·æ ¼æ˜¾ç¤º
                function formatPrice(price) {
                    if (!price) return 'å¸‚ä»·';
                    
                    const p = parseFloat(price);
                    
                    if (p >= 1000) {
                        return p.toLocaleString('en-US', {minimumFractionDigits: 0, maximumFractionDigits: 0});
                    } else if (p >= 1) {
                        return p.toFixed(2);
                    } else {
                        return p.toFixed(4);
                    }
                }
                
                const formattedAmount = formatAmount(order.amount, order.symbol);
                const formattedPrice = formatPrice(order.price);
                
                // æ ¼å¼åŒ–è®¢å•é‡‘é¢
                const formattedCost = order.cost ? `$${parseFloat(order.cost).toFixed(2)}` : 
                    (order.price && order.amount ? `$${(parseFloat(order.price) * parseFloat(order.amount)).toFixed(2)}` : '-');
                
                html += `
                    <tr>
                        <td>${order.symbol}</td>
                        <td class="${sideClass}">${sideText} ${typeText}</td>
                        <td>${formattedAmount}</td>
                        <td>$${formattedPrice}</td>
                        <td>${formattedCost}</td>
                        <td><span style="color: ${statusColor};">${statusText}</span></td>
                    </tr>
                `;
            });
            
            html += '</table></div>';
            container.innerHTML = html;
        }

       
        // æ›´æ–°æœ€è¿‘äº¤æ˜“
        function updateRecentTrades(trades) {
            const container = document.getElementById('recentTrades');
            
            if (!trades || trades.length === 0) {
                container.innerHTML = '<div class="loading">æš‚æ— äº¤æ˜“è®°å½•</div>';
                return;
            }
            
            let html = '<div class="table-container"><table class="table"><tr><th>äº¤æ˜“å¯¹</th><th>ç±»å‹</th><th>æ•°é‡</th><th>ä»·æ ¼</th><th>æ€»é‡‘é¢</th><th>æ‰‹ç»­è´¹(U)</th><th>æ—¶é—´</th></tr>';
            
            trades.slice(0, 10).forEach(trade => {
                // æ ¼å¼åŒ–æ•°é‡ï¼Œæœ€å¤šæ˜¾ç¤º6ä½å°æ•°
                const formattedAmount = parseFloat(trade.amount).toFixed(6).replace(/\.?0+$/, '');
                
                // æ ¼å¼åŒ–æ€»é‡‘é¢
                const formattedCost = trade.cost ? `$${parseFloat(trade.cost).toFixed(2)}` : '-';
                
                // æ ¼å¼åŒ–æ‰‹ç»­è´¹
                const formattedFee = trade.fee ? `$${parseFloat(trade.fee).toFixed(2)}` : '-';
                
                // æ ¼å¼åŒ–æ—¶é—´æ˜¾ç¤º
                const formattedDateTime = trade.datetime ? 
                    new Date(trade.datetime).toLocaleString('zh-CN', {
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit'
                    }) : '-';
                
                html += `
                    <tr>
                        <td>${trade.symbol}</td>
                        <td class="${trade.side === 'buy' ? 'positive' : 'negative'}">${trade.side}</td>
                        <td>${formattedAmount}</td>
                        <td>$${trade.price?.toFixed(2)}</td>
                        <td>${formattedCost}</td>
                        <td style="color: #dc3545; font-size: 0.9em;">${formattedFee}</td>
                        <td style="font-size: 0.9em; color: #666;">${formattedDateTime}</td>
                    </tr>
                `;
            });
            
            html += '</table></div>';
            container.innerHTML = html;
        }

        // æ›´æ–°æŠ•èµ„ç»„åˆå›¾è¡¨
        function updatePortfolioChart(historyData) {
            const ctx = document.getElementById('portfolioChart').getContext('2d');
            
            // å¦‚æœå›¾è¡¨å·²å­˜åœ¨ï¼Œå…ˆé”€æ¯
            if (portfolioChart) {
                portfolioChart.destroy();
            }
            
            const history = historyData.history || [];
            
            if (history.length === 0) {
                ctx.fillStyle = '#666';
                ctx.textAlign = 'center';
                ctx.font = '16px Arial';
                ctx.fillText('æš‚æ— å†å²æ•°æ®', ctx.canvas.width / 2, ctx.canvas.height / 2);
                return;
            }
            
            // å‡†å¤‡å›¾è¡¨æ•°æ®
            const labels = history.map(item => {
                const date = new Date(item.date);
                return `${date.getMonth() + 1}/${date.getDate()}`;
            });
            
            const totalValueData = history.map(item => item.total_value);
            const returnRateData = history.map(item => item.return_rate);
            
            // åˆ›å»ºçº¿å›¾æ˜¾ç¤ºæŠ•èµ„ç»„åˆä»·å€¼èµ°åŠ¿
            portfolioChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'æŠ•èµ„ç»„åˆæ€»ä»·å€¼ ($)',
                        data: totalValueData,
                        borderColor: '#2196F3',
                        backgroundColor: 'rgba(33, 150, 243, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4,
                        yAxisID: 'y'
                    }, 
                    // {
                    //     label: 'æ”¶ç›Šç‡ (%)',
                    //     data: returnRateData,
                    //     borderColor: '#4CAF50',
                    //     backgroundColor: 'rgba(76, 175, 80, 0.1)',
                    //     borderWidth: 2,
                    //     fill: false,
                    //     tension: 0.4,
                    //     yAxisID: 'y1'
                    // }
                ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    scales: {
                        x: {
                            display: true,
                            title: {
                                display: true,
                                text: 'æ—¥æœŸ'
                            }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'æŠ•èµ„ç»„åˆä»·å€¼ ($)'
                            },
                            grid: {
                                drawOnChartArea: true,
                            },
                        },
                        // y1: {
                        //     type: 'linear',
                        //     display: true,
                        //     position: 'right',
                        //     title: {
                        //         display: true,
                        //         text: 'æ”¶ç›Šç‡ (%)'
                        //     },
                        //     grid: {
                        //         drawOnChartArea: false,
                        //     },
                        // }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            callbacks: {
                                title: function(context) {
                                    const index = context[0].dataIndex;
                                    return history[index].date;
                                },
                                label: function(context) {
                                    const value = context.raw;
                                    if (context.datasetIndex === 0) {
                                        return `æ€»ä»·å€¼: $${value.toFixed(2)}`;
                                    } else {
                                        const index = context.dataIndex;
                                        const returnRate = history[index].return_rate;
                                        return `æ”¶ç›Šç‡: ${returnRate.toFixed(2)}%`;
                                    }
                                }
                            }
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>
