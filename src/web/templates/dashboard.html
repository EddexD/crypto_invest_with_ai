<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>智能加密货币投资助手</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            position: relative;
        }

        .github-link {
            position: absolute;
            top: 20px;
            right: 20px;
            color: white;
            text-decoration: none;
            font-size: 24px;
            transition: transform 0.3s ease, opacity 0.3s ease;
            z-index: 10;
        }

        .github-link:hover {
            transform: scale(1.2);
            opacity: 0.8;
            color: #f0f0f0;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .smart-analysis-section {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .chart-section {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .portfolio-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .orders-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .card-title {
            font-size: 1.3em;
            margin-bottom: 15px;
            color: #333;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 10px;
        }

        .metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .metric:last-child {
            border-bottom: none;
        }

        .metric-label {
            color: #666;
        }

        .metric-value {
            font-weight: bold;
            font-size: 1.1em;
        }

        .positive {
            color: #4CAF50;
        }

        .negative {
            color: #f44336;
        }

        .recommendation {
            border-left: 4px solid #2196F3;
            padding: 15px;
            margin: 10px 0;
            background: #f8f9ff;
            border-radius: 5px;
        }

        .recommendation.buy {
            border-left-color: #4CAF50;
            background: #f8fff8;
        }

        .recommendation.sell {
            border-left-color: #f44336;
            background: #fff8f8;
        }

        .recommendation.hold {
            border-left-color: #ff9800;
            background: #fffdf8;
        }

        .recommendation-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .recommendation-symbol {
            font-weight: bold;
            font-size: 1.2em;
        }

        .recommendation-action {
            padding: 5px 15px;
            border-radius: 20px;
            color: white;
            font-weight: bold;
            text-transform: uppercase;
        }

        .action-buy {
            background: #4CAF50;
        }

        .action-sell {
            background: #f44336;
        }

        .action-hold {
            background: #ff9800;
        }

        .confidence-bar {
            width: 100%;
            height: 10px;
            background: #e0e0e0;
            border-radius: 5px;
            overflow: hidden;
            margin: 10px 0;
        }

        .confidence-fill {
            height: 100%;
            background: linear-gradient(90deg, #f44336, #ff9800, #4CAF50);
            transition: width 0.3s ease;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 0.9em; /* 减小字体大小 */
            overflow-x: auto; /* 允许水平滚动 */
        }

        .table th,
        .table td {
            padding: 8px 6px; /* 减小内边距 */
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
            white-space: nowrap; /* 防止文字换行 */
        }

        .table th {
            background: #f5f5f5;
            font-weight: bold;
            color: #333;
            font-size: 0.85em; /* 表头字体更小 */
        }

        .table tr:hover {
            background: #f9f9f9;
        }

        /* 持仓详情表格的特殊样式 */
        #positions .table {
            font-size: 0.8em; /* 持仓表格字体更小 */
        }

        #positions .table th,
        #positions .table td {
            padding: 6px 4px; /* 持仓表格内边距更小 */
        }

        /* 为表格添加滚动容器 */
        .table-container {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch; /* iOS平滑滚动 */
        }

        /* 响应式优化 */
        @media (max-width: 768px) {
            .table {
                font-size: 0.75em;
            }
            
            .table th,
            .table td {
                padding: 4px 2px;
            }
            
            #positions .table {
                font-size: 0.7em;
            }
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 20px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .error {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            border-left: 4px solid #c62828;
        }

        .refresh-btn {
            background: #2196F3;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            transition: background 0.3s ease;
        }

        .refresh-btn:hover {
            background: #1976D2;
        }

        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        .status-online {
            background: #4CAF50;
            box-shadow: 0 0 10px rgba(76, 175, 80, 0.5);
        }

        .status-offline {
            background: #f44336;
            box-shadow: 0 0 10px rgba(244, 67, 54, 0.5);
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.3; }
        }

        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .smart-analysis-section {
                grid-template-columns: 1fr;
            }
            
            .chart-section {
                grid-template-columns: 1fr;
            }
            
            .portfolio-section {
                grid-template-columns: 1fr;
            }
            
            .orders-section {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .container {
                padding: 10px;
            }

            .github-link {
                top: 15px;
                right: 15px;
                font-size: 20px;
            }
            
            /* AI分析卡片特殊优化 */
            .card:has(.analysis-container),
            .card:has(.basic-analysis-container) {
                padding: 8px !important;
                margin: 10px 5px !important;
            }
            
            .card h3 {
                font-size: 1.1em;
                margin-bottom: 10px;
                padding: 0 5px;
            }

            /* AI分析内容移动端优化 */
            .analysis-container {
                word-wrap: break-word;
                overflow-wrap: break-word;
                max-width: 100%;
                width: 100% !important;
                padding: 0 5px !important;
            }

            .analysis-section {
                margin-bottom: 15px !important;
                width: 100% !important;
            }

            .analysis-section div {
                padding: 15px !important;
                font-size: 0.9em !important;
                word-wrap: break-word;
                overflow-wrap: break-word;
                hyphens: auto;
                width: 100% !important;
                box-sizing: border-box !important;
            }

            .confidence-indicator {
                flex-wrap: wrap;
                margin-bottom: 15px !important;
                display: flex !important;
                flex-direction: row !important;
                align-items: center !important;
                gap: 10px !important;
                width: 100% !important;
            }

            .confidence-indicator span {
                font-size: 0.9em;
                margin: 0;
                flex-shrink: 0;
            }

            .confidence-bar {
                flex: 1 !important;
                min-width: 80px !important;
                max-width: 120px !important;
                margin: 0 !important;
            }

            /* 基础分析容器优化 */
            .basic-analysis-container {
                max-width: 100%;
                overflow-x: hidden;
                width: 100% !important;
                padding: 0 5px !important;
            }

            .basic-analysis-container div[style*="grid"] {
                display: block !important;
                grid-template-columns: none !important;
                width: 100% !important;
            }

            .basic-analysis-container div[style*="grid"] > div {
                margin-bottom: 10px;
                padding: 12px;
                font-size: 0.9em;
                width: 100% !important;
                box-sizing: border-box !important;
            }

            /* 长文本内容优化 */
            h3, h4, h5 {
                font-size: 1em !important;
                line-height: 1.3;
                margin: 10px 0 5px 0 !important;
                word-wrap: break-word;
            }

            /* 统计信息文本优化 */
            div[style*="text-align: center"] {
                font-size: 0.8em !important;
                line-height: 1.4;
                padding: 0 5px;
            }

            /* 防止代码或长单词溢出 */
            code, pre {
                word-break: break-all;
                white-space: pre-wrap;
                max-width: 100%;
                overflow-x: auto;
            }

            /* 表格在AI分析中的优化 */
            .analysis-container .table-container {
                font-size: 0.7em;
            }
        }

        /* AI分析内容样式优化 */
        .analysis-container {
            max-width: 100%;
            overflow-x: hidden;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .analysis-section {
            max-width: 100%;
            overflow-x: hidden;
        }

        .analysis-section div {
            max-width: 100%;
            overflow-x: hidden;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        /* 防止长URL或代码块溢出 */
        .analysis-container p,
        .analysis-container div,
        .analysis-container span {
            word-break: break-word;
            overflow-wrap: break-word;
            hyphens: auto;
        }

        /* 异步分析样式 */
        .analysis-loading {
            text-align: center;
            padding: 40px 20px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 15px;
            border: 2px dashed #6c757d;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
            margin: 20px 0;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #28a745, #20c997, #17a2b8);
            border-radius: 10px;
            transition: width 0.5s ease;
            position: relative;
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent 33%, rgba(255,255,255,0.3) 33%, rgba(255,255,255,0.3) 66%, transparent 66%);
            background-size: 30px 30px;
            animation: progressStripe 1s linear infinite;
        }

        @keyframes progressStripe {
            0% { background-position: 0 0; }
            100% { background-position: 30px 0; }
        }

        .progress-text {
            font-size: 0.9em;
            color: #6c757d;
            margin-top: 10px;
        }

        .cancel-btn, .retry-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 15px;
            font-size: 0.9em;
            transition: background 0.3s ease;
        }

        .retry-btn {
            background: #28a745;
        }

        .cancel-btn:hover {
            background: #c82333;
        }

        .retry-btn:hover {
            background: #1e7e34;
        }

        .error {
            text-align: center;
            padding: 30px;
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 10px;
            color: #721c24;
        }

        .cancelled {
            text-align: center;
            padding: 30px;
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 10px;
            color: #856404;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #6c757d;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <a href="https://github.com/2024baibai/crypto_invest_with_ai" target="_blank" class="github-link" title="GitHub Repository">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
                </svg>
            </a>
            <h1>🤖 智能加密货币投资助手</h1>
            <p>智能分析 · 精准建议 · 稳健投资</p>
            <div style="margin-top: 15px;">
                <span class="status-indicator" id="statusIndicator"></span>
                <span id="statusText">连接中...</span>
                <span id="wsStatus" style="margin-left: 20px; font-size: 0.9em; color: #666;"></span>
                <button class="refresh-btn" onclick="refreshAllData()" style="margin-left: 20px;">刷新数据</button>
                <button class="refresh-btn" onclick="saveSnapshot()" style="margin-left: 10px;">保存快照</button>
                <button class="refresh-btn" onclick="toggleWebSocket()" style="margin-left: 10px;" id="wsToggleBtn">重连WS</button>
            </div>
        </div>

        <!-- 第一行：投资组合表现图表 -->
        <div class="chart-section">
            <div class="card">
                <div class="card-title">📈 投资组合表现</div>
                <div class="chart-container">
                    <canvas id="portfolioChart"></canvas>
                </div>
            </div>
        </div>

        <!-- 第三行：投资组合概览、市场数据、持仓详情 -->
        <div class="portfolio-section">
            <!-- 投资组合概览 -->
            <div class="card">
                <div class="card-title">📊 投资组合概览</div>
                <div id="portfolioOverview">
                    <div class="loading">加载中...</div>
                </div>
            </div>

            <!-- 市场数据 -->
            <div class="card">
                <div class="card-title">📈 市场数据</div>
                <div id="marketData">
                    <div class="loading">加载中...</div>
                </div>
            </div>

            <!-- 持仓详情 -->
            <div class="card">
                <div class="card-title">💰 持仓详情</div>
                <div id="positions">
                    <div class="loading">加载中...</div>
                </div>
            </div>
        </div>

        <!-- 第三行：订单信息 -->
        <div class="orders-section">
            <div class="card">
                <div class="card-title">📋 未完成订单</div>
                <div id="openOrders">
                    <div class="loading">加载中...</div>
                </div>
            </div>

            <div class="card">
                <div class="card-title">🔄 最近交易</div>
                <div id="recentTrades">
                    <div class="loading">加载中...</div>
                </div>
            </div>
        </div>

        <!-- 第四行：智能投资分析（移到最下方） -->
        <div class="smart-analysis-section">
            <div class="card">
                <div class="card-title">
                    🧠 OpenAI智能投资分析
                    <div style="float: right; font-size: 0.8em;">
                        <button onclick="loadSmartAnalysis(true)" class="refresh-btn" title="强制刷新分析">
                            🔄 重新分析
                        </button>
                    </div>
                </div>
                <div id="smartAnalysis">
                    <div class="loading">等待分析...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let portfolioChart = null;
        let currentAnalysisTaskId = null; // 当前分析任务ID
        let socket = null; // WebSocket连接
        let pendingForceRefresh = false; // 记录待处理的强制刷新状态
        let lastDataRequestTime = 0; // 记录最后一次数据请求时间

        // 初始化WebSocket连接
        function initWebSocket() {
            // 配置Socket.IO选项以优化连接
            socket = io({
                transports: ['websocket', 'polling'], // 优先使用websocket
                upgrade: true, // 允许升级到websocket
                rememberUpgrade: true, // 记住升级状态
                timeout: 10000, // 连接超时时间
                reconnection: true, // 自动重连
                reconnectionDelay: 2000, // 重连延迟
                reconnectionDelayMax: 10000, // 最大重连延迟
                maxReconnectionAttempts: 5, // 最大重连次数
                forceNew: false // 不强制创建新连接
            });
            
            // 连接成功事件
            socket.on('connect', function() {
                console.log('WebSocket连接成功，传输方式:', socket.io.engine.transport.name);
                updateStatus('online');
                // 请求初始数据（包含基础分析）
                socket.emit('request_data', {type: 'all'});
                lastDataRequestTime = Date.now(); // 记录请求时间
            });
            
            // 传输升级事件
            socket.io.on('upgrade', function() {
                console.log('连接已升级到WebSocket');
            });
            
            // 连接断开事件
            socket.on('disconnect', function(reason) {
                console.log('WebSocket连接断开，原因:', reason);
                updateStatus('offline');
            });
            
            // 投资组合数据更新
            socket.on('portfolio_update', function(data) {
                console.log('收到投资组合数据更新', data);
                updatePortfolioOverview(data);
                updatePositions(data.positions);
            });
            
            // 市场数据更新
            socket.on('market_update', function(data) {
                console.log('收到市场数据更新', data);
                updateMarketData(data.market_data);
            });
            
            // 订单数据更新
            socket.on('orders_update', function(data) {
                console.log('收到订单数据更新', data);
                updateOpenOrders(data.open_orders);
            });
            
            // 交易数据更新
            socket.on('trades_update', function(data) {
                console.log('收到交易数据更新', data);
                updateRecentTrades(data.trades);
            });
            
            // 投资组合历史数据更新
            socket.on('portfolio_history_update', function(data) {
                console.log('收到投资组合历史数据更新', data);
                updatePortfolioChart(data);
            });
            
            // 投资组合历史数据错误
            socket.on('portfolio_history_error', function(data) {
                console.error('投资组合历史数据错误:', data.error);
                // 可以在这里显示错误信息
            });
            
            // 基础分析数据更新
            socket.on('basic_analysis_update', function(data) {
                console.log('收到基础分析数据更新', data);
                updateBasicAnalysis(data.analysis);
            });
            
            // 基础分析错误
            socket.on('basic_analysis_error', function(data) {
                console.error('基础分析错误:', data.error);
                document.getElementById('smartAnalysis').innerHTML = 
                    `<div class="error">获取基础分析失败: ${data.error}</div>`;
            });
            
            // 智能分析任务启动
            socket.on('smart_analysis_started', function(data) {
                console.log('智能分析任务已启动:', data);
                currentAnalysisTaskId = data.task_id;
                
                // 显示分析进度界面
                const container = document.getElementById('smartAnalysis');
                
                // 创建AI分析进度元素
                const aiAnalysisDiv = document.createElement('div');
                aiAnalysisDiv.id = 'aiAnalysisProgress';
                aiAnalysisDiv.innerHTML = `
                    <div class="analysis-loading" style="margin-bottom: 20px;">
                        <div class="loading-spinner"></div>
                        <h3>🤖 OpenAI AI分析进行中...</h3>
                        <p>正在为您提供更深入的智能分析...</p>
                        <div class="progress-bar">
                            <div class="progress-fill" id="analysisProgress" style="width: 10%;"></div>
                        </div>
                        <div class="progress-text" id="progressText">准备中...</div>
                        <button class="cancel-btn" onclick="cancelAnalysis()">取消AI分析</button>
                    </div>
                `;
                
                // 将AI分析进度插入到基础分析的顶部
                const basicAnalysisContainer = container.querySelector('.basic-analysis-container');
                if (basicAnalysisContainer) {
                    // 如果有基础分析，插入到基础分析之前
                    container.insertBefore(aiAnalysisDiv, basicAnalysisContainer);
                } else {
                    // 如果没有基础分析，直接添加到容器中
                    container.appendChild(aiAnalysisDiv);
                }
                
                // 开始轮询状态
                startWebSocketPolling(data.task_id);
            });
            
            // 智能分析错误
            socket.on('smart_analysis_error', function(data) {
                console.error('智能分析错误:', data.error);
                document.getElementById('smartAnalysis').innerHTML = 
                    `<div class="error">启动智能分析失败: ${data.error}</div>`;
            });
            
            // 分析状态更新
            socket.on('analysis_status_update', function(data) {
                console.log('分析状态更新:', data);
                handleAnalysisStatusUpdate(data);
            });
            
            // 分析状态错误
            socket.on('analysis_status_error', function(data) {
                console.error('分析状态错误:', data.error);
                currentAnalysisTaskId = null;
            });
            
            // 连接错误处理
            socket.on('connect_error', function(error) {
                console.error('WebSocket连接错误:', error);
                updateStatus('offline');
            });
            
            // 快照保存成功
            socket.on('snapshot_save_success', function(data) {
                console.log('快照保存成功:', data);
                alert('✅ 快照保存成功！');
            });
            
            // 快照保存失败
            socket.on('snapshot_save_error', function(data) {
                console.error('快照保存失败:', data.error);
                alert('❌ 保存失败: ' + data.error);
            });
        }

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化WebSocket连接
            initWebSocket();
            
            // 投资组合图表将在接收到历史数据后自动更新
            // WebSocket 'all' 请求已经包含历史数据，无需额外请求
            
            // 智能分析将在WebSocket连接成功后自动启动
            
            // 页面可见性检测
            document.addEventListener('visibilitychange', function() {
                if (document.hidden) {
                    // 页面隐藏时可以暂停某些更新
                    console.log('页面隐藏，减少WebSocket活动');
                } else {
                    // 页面可见时恢复更新
                    console.log('页面可见，恢复WebSocket活动');
                    if (socket && socket.connected) {
                        // 防抖：限制请求频率，避免频繁切换页面时的重复请求
                        const now = Date.now();
                        if (now - lastDataRequestTime > 5000) { // 5秒内不重复请求
                            console.log('页面重新可见，刷新数据');
                            socket.emit('request_data', {type: 'all'});
                            lastDataRequestTime = now;
                        } else {
                            console.log('请求频率限制，跳过此次刷新');
                        }
                    }
                }
            });
            
            // 每5分钟自动刷新智能分析（仅在页面可见时）
            setInterval(() => {
                if (document.hidden) return; // 页面不可见时不刷新
                loadSmartAnalysis(false); // 定时刷新不使用强制刷新
            }, 300000); // 5分钟
        });

        // 保存投资组合快照
        function saveSnapshot() {
            try {
                if (socket && socket.connected) {
                    // 使用WebSocket发送保存快照请求
                    socket.emit('save_snapshot', {});
                } else {
                    // WebSocket未连接时的备用方案
                    console.warn('WebSocket未连接，使用HTTP API备用方案');
                    // saveSnapshotHTTP();
                }
            } catch (error) {
                console.error('保存快照失败:', error);
                alert('❌ 保存失败: ' + error.message);
            }
        }
        
        
        // 刷新所有数据
        function refreshAllData() {
            if (socket && socket.connected) {
                updateStatus('connecting');
                socket.emit('request_data', {type: 'all'});
                lastDataRequestTime = Date.now(); // 记录请求时间
            } else {
                // 如果WebSocket未连接，尝试重新连接
                console.log('WebSocket未连接，尝试重新连接...');
                if (socket) {
                    socket.disconnect();
                }
                initWebSocket();
            }
        }
        
        // 手动请求特定数据
        function requestDataUpdate(dataType) {
            if (socket && socket.connected) {
                socket.emit('request_data', {type: dataType});
            }
        }
        
        // WebSocket重连功能
        function toggleWebSocket() {
            const btn = document.getElementById('wsToggleBtn');
            
            if (socket && socket.connected) {
                // 断开连接
                socket.disconnect();
                btn.textContent = '重连WebSocket';
                updateStatus('offline');
            } else {
                // 重新连接
                btn.textContent = '连接中...';
                btn.disabled = true;
                
                if (socket) {
                    socket.disconnect();
                }
                
                setTimeout(() => {
                    initWebSocket();
                    btn.disabled = false;
                    btn.textContent = socket && socket.connected ? '断开WebSocket' : '重连WebSocket';
                }, 1000);
            }
        }

        // 更新连接状态
        function updateStatus(status) {
            const indicator = document.getElementById('statusIndicator');
            const text = document.getElementById('statusText');
            const wsStatus = document.getElementById('wsStatus');
            const wsToggleBtn = document.getElementById('wsToggleBtn');
            
            if (status === 'online') {
                indicator.className = 'status-indicator status-online';
                text.textContent = '已连接';
                if (socket && socket.connected) {
                    const transport = socket.io.engine ? socket.io.engine.transport.name : 'unknown';
                    wsStatus.textContent = `WebSocket`;
                    wsStatus.style.color = '#28a745';
                    wsToggleBtn.textContent = '断开WS';
                } else {
                    wsStatus.textContent = 'HTTP API';
                    wsStatus.style.color = '#ffc107';
                    wsToggleBtn.textContent = '连接WS';
                }
            } else if (status === 'offline') {
                indicator.className = 'status-indicator status-offline';
                text.textContent = '连接失败';
                wsStatus.textContent = '离线';
                wsStatus.style.color = '#dc3545';
                wsToggleBtn.textContent = '重连WS';
            } else if (status === 'connecting') {
                indicator.className = 'status-indicator';
                text.textContent = '连接中...';
                wsStatus.textContent = '正在连接...';
                wsStatus.style.color = '#6c757d';
                wsToggleBtn.textContent = '连接中...';
            }
        }

        // 加载投资组合历史数据（用于图表）
        function loadPortfolioHistory() {
            try {
                if (socket && socket.connected) {
                    // 通过WebSocket请求历史数据
                    socket.emit('request_data', { type: 'portfolio_history' });
                } else {
                    // WebSocket未连接时使用HTTP API作为备用
                    // loadPortfolioHistoryHTTP();
                }
            } catch (error) {
                console.error('请求投资组合历史数据失败:', error);
                // 备用方案
                // loadPortfolioHistoryHTTP();
            }
        }

      

        // 更新投资组合概览
        function updatePortfolioOverview(data) {
            const container = document.getElementById('portfolioOverview');
            
            container.innerHTML = `
                <div class="metric">
                    <span class="metric-label">总价值</span>
                    <span class="metric-value">$${data.total_value?.toFixed(2) || '0.00'}</span>
                </div>
                <div class="metric">
                    <span class="metric-label">总成本</span>
                    <span class="metric-value">$${data.total_cost?.toFixed(2) || '0.00'}</span>
                </div>
                <div class="metric">
                    <span class="metric-label">未实现盈亏</span>
                    <span class="metric-value ${data.total_pnl >= 0 ? 'positive' : 'negative'}">
                        $${data.total_pnl?.toFixed(2) || '0.00'} (${(data.total_pnl_rate * 100)?.toFixed(2) || '0.00'}%)
                    </span>
                </div>
                <div class="metric">
                    <span class="metric-label">总收益率</span>
                    <span class="metric-value ${data.performance?.total_return >= 0 ? 'positive' : 'negative'}">
                        ${(data.performance?.total_return * 100)?.toFixed(2) || '0.00'}%
                    </span>
                </div>
            `;
        }

        // 更新持仓信息
        function updatePositions(positions) {
            const container = document.getElementById('positions');
            
            if (!positions || positions.length === 0) {
                container.innerHTML = '<div class="loading">暂无持仓</div>';
                return;
            }
            
            let html = '<div class="table-container"><table class="table"><tr><th>币种</th><th>数量</th><th>均价</th><th>市值</th><th>盈亏</th><th>盈利率</th></tr>';
            
            positions.forEach(pos => {
                // 格式化盈利率
                const pnlRate = pos.unrealized_pnl_rate || 0;
                const pnlRateDisplay = `${(pnlRate * 100).toFixed(2)}%`;
                
                html += `
                    <tr>
                        <td>${pos.currency}</td>
                        <td>${pos.amount?.toFixed(4) || '0'}</td>
                        <td>$${pos.avg_price?.toFixed(2) || '0.00'}</td>
                        <td>$${pos.market_value?.toFixed(2) || '0.00'}</td>
                        <td class="${pos.unrealized_pnl >= 0 ? 'positive' : 'negative'}">
                            $${pos.unrealized_pnl?.toFixed(2) || '0.00'}
                        </td>
                        <td class="${pnlRate >= 0 ? 'positive' : 'negative'}">
                            ${pnlRateDisplay}
                        </td>
                    </tr>
                `;
            });
            
            html += '</table></div>';
            container.innerHTML = html;
        }

      

        // 更新市场数据
        function updateMarketData(marketData) {
            const container = document.getElementById('marketData');
            
            if (!marketData || Object.keys(marketData).length === 0) {
                container.innerHTML = '<div class="loading">暂无数据</div>';
                return;
            }
            
            let html = '<div class="table-container"><table class="table"><tr><th>交易对</th><th>价格</th><th>24h变化</th></tr>';
            
            Object.entries(marketData).forEach(([symbol, data]) => {
                html += `
                    <tr>
                        <td>${symbol}</td>
                        <td>$${data.price?.toFixed(2) || '0.00'}</td>
                        <td class="${data.percentage >= 0 ? 'positive' : 'negative'}">
                            ${data.percentage?.toFixed(2) || '0.00'}%
                        </td>
                    </tr>
                `;
            });
            
            html += '</table></div>';
            container.innerHTML = html;
        }

        // 加载智能分析（WebSocket版本）
        async function loadSmartAnalysis(forceRefresh = false) {
            try {
                // 如果已有正在进行的任务，先清理
                if (currentAnalysisTaskId) {
                    currentAnalysisTaskId = null;
                }
                
                // 保存强制刷新状态，供后续使用
                pendingForceRefresh = forceRefresh;
                
                // 检查是否已有基础分析，如果没有则先请求基础分析
                const basicAnalysisContainer = document.querySelector('.basic-analysis-container');
                if (!basicAnalysisContainer && socket && socket.connected) {
                    socket.emit('request_data', { type: 'basic_analysis' });
                    // 等待基础分析完成后再启动AI分析（通过updateBasicAnalysis函数处理）
                    return;
                }
                
                // 如果已有基础分析，直接启动AI分析
                if (socket && socket.connected) {
                    // socket.emit('request_smart_analysis', { force_refresh: forceRefresh });
                    // 清除pending状态
                    pendingForceRefresh = false;
                } else {
                    console.warn('WebSocket未连接，无法启动智能分析。');
                }
                
            } catch (error) {
                console.error('启动智能分析失败:', error);
            }
        }
        
     
        // WebSocket智能轮询 - 用于分析状态
        function startWebSocketPolling(taskId) {
            let pollCount = 0;
            const maxPolls = 150; // 最多轮询150次（大约10分钟）
            
            function poll() {
                pollCount++;
                
                // 前30秒每2秒检查一次，之后每5秒检查一次
                const interval = pollCount < 15 ? 2000 : 5000;
                
                if (socket && socket.connected && currentAnalysisTaskId === taskId) {
                    // 通过WebSocket请求状态更新
                    socket.emit('request_analysis_status', { task_id: taskId });
                    
                    // 如果任务还在进行且未超过最大轮询次数
                    if (pollCount < maxPolls) {
                        setTimeout(poll, interval);
                    } else {
                        // 超过最大轮询次数
                        currentAnalysisTaskId = null;
                        document.getElementById('smartAnalysis').innerHTML = 
                            `<div class="error">
                                <h3>⏰ 轮询超时</h3>
                                <p>分析任务可能需要更长时间，请稍后手动刷新</p>
                                <button onclick="loadSmartAnalysis(true)" class="retry-btn">重新分析</button>
                            </div>`;
                    }
                } else {
                    // WebSocket断开或任务ID变化，停止轮询
                    currentAnalysisTaskId = null;
                }
            }
            
            // 立即开始第一次检查
            setTimeout(poll, 1000); // 1秒后开始轮询
        }
        
        // 处理分析状态更新
        function handleAnalysisStatusUpdate(statusData) {
            const progress = Math.round(statusData.progress * 100);
            const progressBar = document.getElementById('analysisProgress');
            const progressText = document.getElementById('progressText');
            
            if (progressBar) {
                progressBar.style.width = `${progress}%`;
            }
            
            // 更新状态文本
            let statusText = '';
            switch (statusData.status) {
                case 'pending':
                    statusText = '等待处理...';
                    break;
                case 'running':
                    if (progress < 30) {
                        statusText = '获取市场数据...';
                    } else if (progress < 60) {
                        statusText = 'OpenAI AI 分析中...';
                    } else if (progress < 90) {
                        statusText = '生成投资建议...';
                    } else {
                        statusText = '完成分析...';
                    }
                    break;
                case 'completed':
                    statusText = '分析完成！';
                    currentAnalysisTaskId = null; // 清除当前任务ID
                    
                    // 移除AI分析进度显示
                    const progressDiv = document.getElementById('aiAnalysisProgress');
                    if (progressDiv) {
                        progressDiv.remove();
                    }
                    
                    // 用AI分析结果替换或更新现有内容
                    updateSmartAnalysis(statusData.result);
                    return; // 不再继续轮询
                case 'failed':
                    statusText = `分析失败: ${statusData.error}`;
                    currentAnalysisTaskId = null; // 清除当前任务ID
                    document.getElementById('smartAnalysis').innerHTML = 
                        `<div class="error">
                            <h3>❌ 分析失败</h3>
                            <p>${statusData.error}</p>
                            <button onclick="loadSmartAnalysis(true)" class="retry-btn">重新分析</button>
                        </div>`;
                    return; // 不再继续轮询
                case 'timeout':
                    statusText = '分析超时';
                    currentAnalysisTaskId = null; // 清除当前任务ID
                    document.getElementById('smartAnalysis').innerHTML = 
                        `<div class="error">
                            <h3>⏰ 分析超时</h3>
                            <p>OpenAI API响应超时，请稍后重试</p>
                            <button onclick="loadSmartAnalysis(true)" class="retry-btn">重新分析</button>
                        </div>`;
                    return; // 不再继续轮询
            }
            
            if (progressText) {
                progressText.textContent = `${statusText} (${progress}%)`;
            }
        }


        // 取消分析
        function cancelAnalysis() {
            if (currentAnalysisTaskId) {
                currentAnalysisTaskId = null;
            }
            currentAnalysisTaskId = null;
            
            document.getElementById('smartAnalysis').innerHTML = 
                `<div class="cancelled">
                    <h3>🛑 分析已取消</h3>
                    <p>您可以随时重新开始分析</p>
                    <button onclick="loadSmartAnalysis(true)" class="retry-btn">开始分析</button>
                </div>`;
        }

        // 更新基础分析显示
        function updateBasicAnalysis(analysisData) {
            const container = document.getElementById('smartAnalysis');
            
            if (!analysisData) {
                // 只有在没有AI分析进度时才显示"暂无分析数据"
                const aiProgress = document.getElementById('aiAnalysisProgress');
                if (!aiProgress) {
                    container.innerHTML = '<div class="loading">暂无分析数据</div>';
                }
                return;
            }
            
            // 检查是否已有AI分析进度在显示
            const existingProgress = document.getElementById('aiAnalysisProgress');
            
            let html = `
                <div class="basic-analysis-container">
                    <div style="background: #e8f4fd; padding: 10px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #007bff;">
                        <h4 style="color: #007bff; margin: 0;">📊 快速投资组合分析</h4>
                        <p style="margin: 5px 0 0 0; color: #666; font-size: 0.9em;">基于当前数据的即时分析，AI深度分析即将启动...</p>
                    </div>

                    <!-- 投资组合概览 -->
                    <div class="analysis-section" style="margin-bottom: 20px;">
                        <h4 style="color: #2c3e50; margin-bottom: 10px;">💼 投资组合概览</h4>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #28a745;">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                                <div>
                                    <strong>总价值:</strong> $${analysisData.portfolio_overview.total_value.toFixed(2)} USDT<br>
                                    <strong>总成本:</strong> $${analysisData.portfolio_overview.total_cost.toFixed(2)} USDT<br>
                                    <strong>盈亏:</strong> <span style="color: ${analysisData.portfolio_overview.total_pnl >= 0 ? '#28a745' : '#dc3545'}">
                                        $${analysisData.portfolio_overview.total_pnl.toFixed(2)} (${(analysisData.portfolio_overview.total_pnl_rate * 100).toFixed(2)}%)
                                    </span>
                                </div>
                                <div>
                                    <strong>持仓数量:</strong> ${analysisData.portfolio_overview.total_positions}<br>
                                    <strong>盈利持仓:</strong> ${analysisData.portfolio_overview.profitable_positions}<br>
                                    <strong>亏损持仓:</strong> ${analysisData.portfolio_overview.loss_positions}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 资产配置 -->
                    <div class="analysis-section" style="margin-bottom: 20px;">
                        <h4 style="color: #2c3e50; margin-bottom: 10px;">🎯 资产配置</h4>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #007bff;">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
                                ${Object.entries(analysisData.asset_allocation).map(([asset, percentage]) => `
                                    <div style="text-align: center; padding: 10px; background: white; border-radius: 5px;">
                                        <strong>${asset}</strong><br>
                                        <span style="font-size: 1.2em; color: #007bff;">${percentage.toFixed(1)}%</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>

                    <!-- 风险评估 -->
                    <div class="analysis-section" style="margin-bottom: 20px;">
                        <h4 style="color: #2c3e50; margin-bottom: 10px;">⚠️ 风险评估</h4>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #ffc107;">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                                <div>
                                    <strong>风险等级:</strong> 
                                    <span style="padding: 3px 8px; border-radius: 4px; background: ${getRiskColor(analysisData.risk_assessment.risk_level)}; color: white;">
                                        ${analysisData.risk_assessment.risk_level}
                                    </span>
                                </div>
                                <div>
                                    <strong>多样化分数:</strong> ${(analysisData.risk_assessment.diversification_score * 100).toFixed(1)}%<br>
                                    <div style="width: 100%; height: 8px; background: #e0e0e0; border-radius: 4px; margin-top: 5px;">
                                        <div style="width: ${analysisData.risk_assessment.diversification_score * 100}%; height: 100%; background: #28a745; border-radius: 4px;"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 基础建议 -->
                    ${analysisData.basic_suggestions && analysisData.basic_suggestions.length > 0 ? `
                    <div class="analysis-section" style="margin-bottom: 20px;">
                        <h4 style="color: #2c3e50; margin-bottom: 10px;">💡 基础建议</h4>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #17a2b8;">
                            ${analysisData.basic_suggestions.map(suggestion => `
                                <div style="margin-bottom: 10px; padding: 10px; background: white; border-radius: 5px; border-left: 3px solid #17a2b8;">
                                    ${suggestion}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    ` : ''}

                    <!-- 分析时间戳 -->
                    <div style="text-align: center; margin-top: 20px; color: #666; font-size: 0.9em;">
                        基础分析时间: ${new Date(analysisData.analysis_timestamp).toLocaleString('zh-CN')}
                    </div>
                </div>
            `;
            
            if (existingProgress) {
                // 如果已有AI分析进度，将基础分析插入到进度后面
                existingProgress.insertAdjacentHTML('afterend', html);
            } else {
                // 如果没有AI分析进度，直接替换整个容器内容
                container.innerHTML = html;
                
                // 基础分析显示完成后，启动AI分析
                setTimeout(() => {
                    startSmartAnalysisAfterBasic();
                }, 500);
            }
        }
        
        // 基础分析完成后启动AI分析
        function startSmartAnalysisAfterBasic() {
            // 检查WebSocket连接状态
            if (socket && socket.connected) {
                // 使用保存的强制刷新状态启动AI分析
                socket.emit('request_smart_analysis', { force_refresh: pendingForceRefresh });
                // 清除pending状态
                pendingForceRefresh = false;
            } else {
                console.warn('WebSocket未连接，无法启动AI分析');
            }
        }

        // 获取风险等级颜色
        function getRiskColor(riskLevel) {
            switch(riskLevel) {
                case '低风险': return '#28a745';
                case '中等风险': return '#ffc107';
                case '中高风险': return '#fd7e14';
                case '高风险': return '#dc3545';
                default: return '#6c757d';
            }
        }

        // 加载智能分析（同步版本，用于快速查看）
       
        // 更新智能分析显示（简化版本，后端已处理格式化）
        // 重新设计的Markdown转HTML函数 - 处理复杂结构
        function markdownToHtml(markdown) {
            if (!markdown) return '';
            
            // 清理输入并按行分割
            let lines = markdown.trim().split('\n');
            let html = '';
            let inList = false;
            
            for (let i = 0; i < lines.length; i++) {
                let line = lines[i];
                let trimmedLine = line.trim();
                
                // 跳过空行
                if (!trimmedLine) {
                    // 如果在列表中遇到空行，结束列表
                    if (inList) {
                        html += '</ul>';
                        inList = false;
                    }
                    continue;
                }
                
                // 处理标题
                if (trimmedLine.startsWith('###')) {
                    if (inList) { html += '</ul>'; inList = false; }
                    const title = trimmedLine.replace(/^###\s*/, '');
                    html += `<h5 style="color: #495057; margin: 15px 0 8px 0; font-weight: bold; font-size: 1.05em; border-bottom: 1px solid #e9ecef; padding-bottom: 4px;">${formatInlineText(title)}</h5>`;
                }
                else if (trimmedLine.startsWith('##')) {
                    if (inList) { html += '</ul>'; inList = false; }
                    const title = trimmedLine.replace(/^##\s*/, '');
                    html += `<h4 style="color: #343a40; margin: 18px 0 10px 0; font-weight: bold; font-size: 1.1em; border-bottom: 2px solid #dee2e6; padding-bottom: 6px;">${formatInlineText(title)}</h4>`;
                }
                else if (trimmedLine.startsWith('#')) {
                    if (inList) { html += '</ul>'; inList = false; }
                    const title = trimmedLine.replace(/^#\s*/, '');
                    html += `<h3 style="color: #212529; margin: 20px 0 12px 0; font-weight: bold; font-size: 1.2em; border-bottom: 3px solid #007bff; padding-bottom: 8px;">${formatInlineText(title)}</h3>`;
                }
                // 处理数字标题 (如 "1. **USDT余额配置建议**：")
                else if (/^\d+\.\s+/.test(trimmedLine)) {
                    if (inList) { html += '</ul>'; inList = false; }
                    html += `<h5 style="color: #495057; margin: 12px 0 8px 0; font-weight: bold; font-size: 1.05em; background: #f8f9fa; padding: 8px 12px; border-left: 4px solid #007bff; border-radius: 4px;">${formatInlineText(trimmedLine)}</h5>`;
                }
                // 处理emoji开头的主标题
                else if (/^(📊|📈|🎯|💼|⚡|⚠️|💡|📋|🤖|💰|🔍|📌|⚖️|🚀|🛡️|✅|🟡|🟢|🔽|🔼|📉|📈|🟢)\s+/.test(trimmedLine)) {
                    if (inList) { html += '</ul>'; inList = false; }
                    html += `<h4 style="color: #2c3e50; margin: 14px 0 8px 0; font-weight: bold; font-size: 1.05em; background: linear-gradient(90deg, #f8f9fa, #ffffff); padding: 10px 15px; border-left: 4px solid #28a745; border-radius: 6px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">${formatInlineText(trimmedLine)}</h4>`;
                }
                // 处理列表项（包括有缩进的）
                else if (trimmedLine.startsWith('- ') || trimmedLine.startsWith('* ') || trimmedLine.startsWith('+ ')) {
                    if (!inList) {
                        html += '<ul style="margin: 8px 0; padding-left: 20px; list-style-type: disc;">';
                        inList = true;
                    }
                    const content = trimmedLine.replace(/^[-*+]\s+/, '');
                    html += `<li style="margin: 4px 0; padding-left: 8px; color: #495057; line-height: 1.5;">${formatInlineText(content)}</li>`;
                }
                // 处理缩进的文本（可能是子项）
                else if (line.startsWith('  ') || line.startsWith('\t')) {
                    // 如果当前没有在列表中，但这是缩进文本，作为子项处理
                    if (!inList) {
                        html += '<ul style="margin: 8px 0; padding-left: 20px; list-style-type: disc;">';
                        inList = true;
                    }
                    html += `<li style="margin: 4px 0; padding-left: 8px; color: #495057; line-height: 1.5;">${formatInlineText(trimmedLine)}</li>`;
                }
                // 处理普通段落
                else {
                    if (inList) { html += '</ul>'; inList = false; }
                    html += `<p style="margin: 8px 0; line-height: 1.6; color: #495057; font-size: 0.95em;">${formatInlineText(trimmedLine)}</p>`;
                }
            }
            
            // 确保最后关闭列表
            if (inList) {
                html += '</ul>';
            }
            
            return html;
        }
        
        // 处理行内格式（粗体、斜体等）
        function formatInlineText(text) {
            return text
                // 处理粗体
                .replace(/\*\*(.*?)\*\*/g, '<strong style="color: #2c3e50; font-weight: 600; background: #fff3cd; padding: 2px 4px; border-radius: 3px;">$1</strong>')
                // 处理斜体
                .replace(/\*(.*?)\*/g, '<em style="color: #495057; font-style: italic;">$1</em>')
                // 处理代码
                .replace(/`(.*?)`/g, '<code style="background: #f1f3f4; padding: 2px 4px; border-radius: 3px; font-family: monospace;">$1</code>')
                // 处理价格（如 $113,500）
                .replace(/\$([0-9,]+(?:\.[0-9]+)?)/g, '<span style="color: #007bff; font-weight: 600;">$$$1</span>')
                // 处理百分比
                .replace(/([0-9]+(?:\.[0-9]+)?)%/g, '<span style="color: #28a745; font-weight: 600;">$1%</span>');
        }

        function updateSmartAnalysis(analysisData) {
            const container = document.getElementById('smartAnalysis');
            
            if (!analysisData) {
                container.innerHTML = '<div class="loading">暂无分析数据</div>';
                return;
            }
            
            // 清理基础分析内容，为AI分析结果让路
            const basicAnalysisContainer = container.querySelector('.basic-analysis-container');
            if (basicAnalysisContainer) {
                basicAnalysisContainer.remove();
            }
            
            // 如果有原始AI响应，直接显示
            if (analysisData.ai_response) {
                let html = `
                    <div class="analysis-container">
                        <!-- AI置信度指示器 -->
                        <div class="confidence-indicator" style="margin-bottom: 20px; display: flex; align-items: center; flex-wrap: wrap; width: 100%;">
                            <span style="font-weight: bold; margin-right: 10px; flex-shrink: 0;">AI分析置信度:</span>
                            <div class="confidence-bar" style="display: inline-block; width: 100px; height: 20px; background: #f0f0f0; border-radius: 10px; margin: 0 10px; position: relative; flex: 1; max-width: 120px;">
                                <div style="width: ${(analysisData.ai_confidence * 100)}%; height: 100%; background: linear-gradient(90deg, #28a745, #ffc107, #dc3545); border-radius: 10px;"></div>
                            </div>
                            <span style="font-weight: bold; white-space: nowrap; flex-shrink: 0;">${(analysisData.ai_confidence * 100).toFixed(1)}%</span>
                        </div>

                        <!-- 原始AI分析内容 -->
                        <div class="analysis-section" style="margin-bottom: 20px; width: 100%;">
                            <h4 style="color: #2c3e50; margin-bottom: 10px; word-wrap: break-word;">🤖 OpenAI AI 投资分析</h4>
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #007bff; line-height: 1.6; font-size: 0.95em; word-wrap: break-word; overflow-wrap: break-word; max-width: 100%; overflow-x: hidden; width: 100%; box-sizing: border-box;">
                                ${analysisData.ai_response}
                            </div>
                        </div>

                        <!-- 分析时间戳 -->
                        <div style="text-align: center; margin-top: 20px; color: #666; font-size: 0.9em; word-wrap: break-word;">
                            分析时间: ${new Date(analysisData.analysis_timestamp).toLocaleString('zh-CN')}
                        </div>
                    </div>
                `;
                container.innerHTML = html;
                return;
            }
            
            // 兼容旧格式：如果没有ai_response但有其他字段，显示分段格式
            if (analysisData.market_analysis || analysisData.portfolio_review || analysisData.trading_signals || analysisData.risk_assessment) {
                let html = `
                    <div class="analysis-container">
                        <!-- AI置信度指示器 -->
                        <div class="confidence-indicator" style="margin-bottom: 20px; display: flex; align-items: center; flex-wrap: wrap; width: 100%;">
                            <span style="font-weight: bold; margin-right: 10px; flex-shrink: 0;">分析置信度:</span>
                            <div class="confidence-bar" style="display: inline-block; width: 100px; height: 20px; background: #f0f0f0; border-radius: 10px; margin: 0 10px; position: relative; flex: 1; max-width: 120px;">
                                <div style="width: ${(analysisData.ai_confidence * 100)}%; height: 100%; background: linear-gradient(90deg, #28a745, #ffc107, #dc3545); border-radius: 10px;"></div>
                            </div>
                            <span style="font-weight: bold; white-space: nowrap; flex-shrink: 0;">${(analysisData.ai_confidence * 100).toFixed(1)}%</span>
                        </div>

                        
                        <!-- 风险评估 -->
                        ${analysisData.risk_assessment ? `
                        <div class="analysis-section" style="margin-bottom: 20px; width: 100%;">
                            <h4 style="color: #2c3e50; margin-bottom: 10px; word-wrap: break-word;">📊  市场趋势分析</h4>
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #dc3545; line-height: 1.6; word-wrap: break-word; overflow-wrap: break-word; max-width: 100%; overflow-x: hidden; width: 100%; box-sizing: border-box;">
                                ${analysisData.risk_assessment}
                            </div>
                        </div>
                        ` : ''}

                        <!-- 市场分析 -->
                        ${analysisData.market_analysis ? `
                        <div class="analysis-section" style="margin-bottom: 20px; width: 100%;">
                            <h4 style="color: #2c3e50; margin-bottom: 10px; word-wrap: break-word;">📊 币种分析</h4>
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #007bff; line-height: 1.6; word-wrap: break-word; overflow-wrap: break-word; max-width: 100%; overflow-x: hidden; width: 100%; box-sizing: border-box;">
                                ${analysisData.market_analysis}
                            </div>
                        </div>
                        ` : ''}

                        <!-- 分析时间戳 -->
                        <div style="text-align: center; margin-top: 20px; color: #666; font-size: 0.9em; word-wrap: break-word;">
                            分析时间: ${new Date(analysisData.analysis_timestamp).toLocaleString('zh-CN')}
                        </div>
                    </div>
                `;
                
                container.innerHTML = html;
                return;
            }
            
            // 如果没有任何有效数据
            container.innerHTML = '<div class="loading">暂无分析数据</div>';
        }

        // 获取操作颜色
        function getActionColor(action) {
            switch(action) {
                case 'BUY': return '#28a745';
                case 'SELL': return '#dc3545';
                case 'HOLD': return '#ffc107';
                default: return '#6c757d';
            }
        }

        // 获取操作文本
        function getActionText(action) {
            switch(action) {
                case 'BUY': return '买入';
                case 'SELL': return '卖出';
                case 'HOLD': return '持有';
                default: return action;
            }
        }

        // 保持向后兼容的AI建议加载函数
        async function loadRecommendations() {
            return loadSmartAnalysis(false); // 建议加载不使用强制刷新
        }

     
        // 更新未完成订单
        function updateOpenOrders(orders) {
            const container = document.getElementById('openOrders');
            
            if (!orders || orders.length === 0) {
                container.innerHTML = '<div class="loading">暂无未完成订单</div>';
                return;
            }
            
            let html = '<div class="table-container"><table class="table"><tr><th>交易对</th><th>类型</th><th>数量</th><th>价格</th><th>金额</th><th>状态</th></tr>';
            
            orders.forEach(order => {
                const sideClass = order.side === 'buy' ? 'positive' : 'negative';
                const sideText = order.side === 'buy' ? '买入' : '卖出';
                
                // 确定订单类型显示文本
                let typeText = '限价';
                let statusText = '等待成交';
                let statusColor = '#007bff';
                
                const orderType = order.type?.toLowerCase() || '';
                
                if (orderType === 'market') {
                    typeText = '市价';
                } else if (orderType.includes('stop')) {
                    typeText = order.side === 'buy' ? '止损买入' : '止损卖出';
                    statusText = '待触发';
                    statusColor = '#ffc107';
                } else if (orderType.includes('take_profit')) {
                    typeText = '止盈';
                    statusText = '待触发';
                    statusColor = '#ffc107';
                } else if (orderType.includes('oco')) {
                    typeText = 'OCO订单';
                    statusText = '待触发';
                    statusColor = '#ffc107';
                } else if (orderType.includes('trigger')) {
                    typeText = '触发订单';
                    statusText = '待触发';
                    statusColor = '#ffc107';
                } else if (orderType.includes('conditional')) {
                    typeText = '条件订单';
                    statusText = '待触发';
                    statusColor = '#ffc107';
                }
                
                // 智能格式化数量显示
                function formatAmount(amount, symbol) {
                    const amt = parseFloat(amount);
                    
                    // 根据币种和数量大小决定精度
                    if (symbol.includes('BTC')) {
                        return amt.toFixed(6); // BTC保留6位小数
                    } else if (symbol.includes('ETH')) {
                        return amt.toFixed(4); // ETH保留4位小数
                    } else if (symbol.includes('ADA')) {
                        return amt.toFixed(0); // ADA等小价值币种保留整数
                    } else if (amt < 1) {
                        return amt.toFixed(6); // 小于1的数量保留6位
                    } else if (amt < 100) {
                        return amt.toFixed(3); // 1-100保留3位
                    } else {
                        return amt.toFixed(0); // 大于100保留整数
                    }
                }
                
                // 智能格式化价格显示
                function formatPrice(price) {
                    if (!price) return '市价';
                    
                    const p = parseFloat(price);
                    
                    if (p >= 1000) {
                        return p.toLocaleString('en-US', {minimumFractionDigits: 0, maximumFractionDigits: 0});
                    } else if (p >= 1) {
                        return p.toFixed(2);
                    } else {
                        return p.toFixed(4);
                    }
                }
                
                const formattedAmount = formatAmount(order.amount, order.symbol);
                const formattedPrice = formatPrice(order.price);
                
                // 格式化订单金额
                const formattedCost = order.cost ? `$${parseFloat(order.cost).toFixed(2)}` : 
                    (order.price && order.amount ? `$${(parseFloat(order.price) * parseFloat(order.amount)).toFixed(2)}` : '-');
                
                html += `
                    <tr>
                        <td>${order.symbol}</td>
                        <td class="${sideClass}">${sideText} ${typeText}</td>
                        <td>${formattedAmount}</td>
                        <td>$${formattedPrice}</td>
                        <td>${formattedCost}</td>
                        <td><span style="color: ${statusColor};">${statusText}</span></td>
                    </tr>
                `;
            });
            
            html += '</table></div>';
            container.innerHTML = html;
        }

       
        // 更新最近交易
        function updateRecentTrades(trades) {
            const container = document.getElementById('recentTrades');
            
            if (!trades || trades.length === 0) {
                container.innerHTML = '<div class="loading">暂无交易记录</div>';
                return;
            }
            
            let html = '<div class="table-container"><table class="table"><tr><th>交易对</th><th>类型</th><th>数量</th><th>价格</th><th>总金额</th><th>手续费(U)</th><th>时间</th></tr>';
            
            trades.slice(0, 10).forEach(trade => {
                // 格式化数量，最多显示6位小数
                const formattedAmount = parseFloat(trade.amount).toFixed(6).replace(/\.?0+$/, '');
                
                // 格式化总金额
                const formattedCost = trade.cost ? `$${parseFloat(trade.cost).toFixed(2)}` : '-';
                
                // 格式化手续费
                const formattedFee = trade.fee ? `$${parseFloat(trade.fee).toFixed(2)}` : '-';
                
                // 格式化时间显示
                const formattedDateTime = trade.datetime ? 
                    new Date(trade.datetime).toLocaleString('zh-CN', {
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit'
                    }) : '-';
                
                html += `
                    <tr>
                        <td>${trade.symbol}</td>
                        <td class="${trade.side === 'buy' ? 'positive' : 'negative'}">${trade.side}</td>
                        <td>${formattedAmount}</td>
                        <td>$${trade.price?.toFixed(2)}</td>
                        <td>${formattedCost}</td>
                        <td style="color: #dc3545; font-size: 0.9em;">${formattedFee}</td>
                        <td style="font-size: 0.9em; color: #666;">${formattedDateTime}</td>
                    </tr>
                `;
            });
            
            html += '</table></div>';
            container.innerHTML = html;
        }

        // 更新投资组合图表
        function updatePortfolioChart(historyData) {
            const ctx = document.getElementById('portfolioChart').getContext('2d');
            
            // 如果图表已存在，先销毁
            if (portfolioChart) {
                portfolioChart.destroy();
            }
            
            const history = historyData.history || [];
            
            if (history.length === 0) {
                ctx.fillStyle = '#666';
                ctx.textAlign = 'center';
                ctx.font = '16px Arial';
                ctx.fillText('暂无历史数据', ctx.canvas.width / 2, ctx.canvas.height / 2);
                return;
            }
            
            // 准备图表数据
            const labels = history.map(item => {
                const date = new Date(item.date);
                return `${date.getMonth() + 1}/${date.getDate()}`;
            });
            
            const totalValueData = history.map(item => item.total_value);
            const returnRateData = history.map(item => item.return_rate);
            
            // 创建线图显示投资组合价值走势
            portfolioChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '投资组合总价值 ($)',
                        data: totalValueData,
                        borderColor: '#2196F3',
                        backgroundColor: 'rgba(33, 150, 243, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4,
                        yAxisID: 'y'
                    }, 
                    // {
                    //     label: '收益率 (%)',
                    //     data: returnRateData,
                    //     borderColor: '#4CAF50',
                    //     backgroundColor: 'rgba(76, 175, 80, 0.1)',
                    //     borderWidth: 2,
                    //     fill: false,
                    //     tension: 0.4,
                    //     yAxisID: 'y1'
                    // }
                ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    scales: {
                        x: {
                            display: true,
                            title: {
                                display: true,
                                text: '日期'
                            }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: '投资组合价值 ($)'
                            },
                            grid: {
                                drawOnChartArea: true,
                            },
                        },
                        // y1: {
                        //     type: 'linear',
                        //     display: true,
                        //     position: 'right',
                        //     title: {
                        //         display: true,
                        //         text: '收益率 (%)'
                        //     },
                        //     grid: {
                        //         drawOnChartArea: false,
                        //     },
                        // }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            callbacks: {
                                title: function(context) {
                                    const index = context[0].dataIndex;
                                    return history[index].date;
                                },
                                label: function(context) {
                                    const value = context.raw;
                                    if (context.datasetIndex === 0) {
                                        return `总价值: $${value.toFixed(2)}`;
                                    } else {
                                        const index = context.dataIndex;
                                        const returnRate = history[index].return_rate;
                                        return `收益率: ${returnRate.toFixed(2)}%`;
                                    }
                                }
                            }
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>
